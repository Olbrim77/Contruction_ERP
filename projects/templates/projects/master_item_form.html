{% extends 'projects/base.html' %}
{% load humanize %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/themes/default/style.min.css" />
<style>
    .container { max-width: 1100px; margin: 0 auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
    .full-width { grid-column: span 2; }
    label { font-weight: bold; margin-bottom: 5px; display: block; color: #555; }
    input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; }

    /* Uniclass mez≈ë */
    .uniclass-display { background: #f0f4f8; border: 1px dashed #005a9c; padding: 10px; border-radius: 4px; cursor: pointer; text-align: center; color: #005a9c; font-weight: bold; }

    /* Komponens t√°bl√°zatok */
    h3 { background: #f8f9fa; padding: 10px; border-left: 5px solid #005a9c; margin-top: 40px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 10px; border-bottom: 1px solid #eee; text-align: left; }
    th { background: #f1f1f1; font-size: 0.9em; text-transform: uppercase; }

    /* Modal */
    .modal { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4); }
    .modal-content { background-color: #fefefe; margin: 5% auto; padding: 20px; border-radius: 8px; width: 60%; height: 70vh; display: flex; flex-direction: column; }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <h1>{{ title }}</h1>

    <form method="POST">
        {% csrf_token %}

        <div class="form-grid">
            <div class="full-width">
                <label>Uniclass Besorol√°s</label>
                <div style="display:none;">{{ form.uniclass_item }}</div>
                <div class="uniclass-display" onclick="openUniclassModal()">
                    <span id="uniclass-text">
                        {% if form.instance.uniclass_item %}
                            {{ form.instance.uniclass_item.code }} - {{ form.instance.uniclass_item.title_en }}
                        {% else %}
                            üìÇ Kattints a kiv√°laszt√°shoz...
                        {% endif %}
                    </span>
                </div>
            </div>
            <div><label>K√≥d</label>{{ form.tetelszam }}</div>
            <div><label>Egys√©g</label>{{ form.egyseg }}</div>
            <div class="full-width"><label>Megnevez√©s</label>{{ form.leiras }}</div>
        </div>

        <h3>üß± Anyagok (Material)</h3>
        {{ mat_formset.management_form }}
        <table>
            <thead><tr><th width="60%">Anyag</th><th width="20%">Mennyis√©g</th><th>T√∂rl√©s</th></tr></thead>
            <tbody>
                {% for f in mat_formset %}
                <tr>
                    <td>{{ f.id }}{{ f.material }}</td> <td>{{ f.amount }}</td>
                    <td>{{ f.DELETE }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <h3>üë∑ Munkad√≠j (Labor)</h3>
        {{ lab_formset.management_form }}
        <table>
            <thead><tr><th width="60%">M≈±velet</th><th width="20%">Norma (√≥ra)</th><th>T√∂rl√©s</th></tr></thead>
            <tbody>
                {% for f in lab_formset %}
                <tr>
                    <td>{{ f.id }}{{ f.operation }}</td>
                    <td>{{ f.time_required }}</td>
                    <td>{{ f.DELETE }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <h3>üöú G√©pek</h3>
        {{ mach_formset.management_form }}
        <table>
            <thead><tr><th width="60%">G√©p</th><th width="20%">Haszn√°lat</th><th>T√∂rl√©s</th></tr></thead>
            <tbody>
                {% for f in mach_formset %}
                <tr>
                    <td>{{ f.id }}{{ f.machine }}</td>
                    <td>{{ f.amount }}</td>
                    <td>{{ f.DELETE }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <div style="margin-top: 30px; text-align: right;">
            <button type="submit" class="btn btn-primary" style="padding: 15px 40px; font-size: 18px;">üíæ MENT√âS</button>
        </div>
    </form>
</div>

<div id="uniclassModal" class="modal">
    <div class="modal-content">
        <span style="text-align:right; cursor:pointer; font-size:24px;" onclick="closeUniclassModal()">&times;</span>
        <h3>Uniclass Keres≈ë</h3>
        <input type="text" id="tree-search" placeholder="Keres√©s..." style="padding:10px; width:100%; border:1px solid #ddd; margin-bottom:10px;">
        <div style="overflow-y: auto; flex-grow: 1;"><div id="uniclass_tree"></div></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/jstree.min.js"></script>
<script>
    var modal = document.getElementById("uniclassModal");
    var treeInitialized = false;
    function openUniclassModal() { modal.style.display = "block"; if(!treeInitialized){ initTree(); treeInitialized=true; } }
    function closeUniclassModal() { modal.style.display = "none"; }
    function initTree() {
        $('#uniclass_tree').jstree({
            'core': { 'data': { 'url': "{% url 'uniclass-tree-data' %}", 'dataType': 'json' } },
            'plugins': ["search", "types"]
        });
        $('#tree-search').keyup(function () { var v = $('#tree-search').val(); $('#uniclass_tree').jstree(true).search(v); });
        $('#uniclass_tree').on("changed.jstree", function (e, data) {
            if(data.selected.length) {
                var node = data.instance.get_node(data.selected[0]);
                document.getElementById('id_uniclass_item').value = node.id;
                document.getElementById('uniclass-text').innerText = node.text;
                closeUniclassModal();
            }
        });
    }
    window.onclick = function(event) { if (event.target == modal) closeUniclassModal(); }
</script>
{% endblock %}