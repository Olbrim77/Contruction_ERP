{% extends 'projects/base.html' %}
{% load humanize %}

{% block title %}{{ project.name }} - Projekt Adatlap{% endblock %}

{% block breadcrumbs %}
    <a href="{% url 'project-list' %}">Projektek</a> / <span>{{ project.name }}</span>
{% endblock %}

{% block extra_css %}
<style>
    .project-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; background: #fff; padding: 20px; border-radius: 8px; border: 1px solid var(--border); }
    .project-title h1 { margin: 0; font-size: 24px; color: var(--primary); }
    .project-meta { color: #666; font-size: 14px; margin-top: 5px; display: flex; gap: 15px; align-items: center; }
    .badge { background: #e9ecef; color: #555; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600; text-transform: uppercase; }

    /* F√úLEK (TABS) */
    .tabs { display: flex; gap: 2px; border-bottom: 2px solid #e1e4e8; margin-bottom: 20px; flex-wrap: wrap; }
    .tab-btn { padding: 10px 20px; cursor: pointer; background: transparent; border: none; font-size: 14px; font-weight: 600; color: #6c757d; border-bottom: 3px solid transparent; transition: all 0.2s; }
    .tab-btn:hover { color: var(--primary); background-color: rgba(0,90,156,0.05); }
    .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }

    .tab-content { display: none; animation: fadeIn 0.3s ease-in-out; }
    .tab-content.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    /* ST√ÅTUSZ S√ÅV */
    .pipeline { display: flex; margin-bottom: 20px; background: #fff; border: 1px solid var(--border); border-radius: 8px; overflow: hidden; }
    .step { flex: 1; padding: 12px; text-align: center; font-size: 12px; background: #f8f9fa; color: #6c757d; text-decoration: none; border-right: 1px solid #fff; display: flex; justify-content: center; align-items: center; }
    .step:last-child { border-right: none; }
    .step.active { background-color: var(--primary); color: white; font-weight: bold; }

    /* T√ÅBL√ÅZAT */
    .excel-table { width: 100%; border-collapse: collapse; background: #fff; border: 1px solid var(--border); font-size: 13px; }
    .excel-table th { background: #f8f9fa; text-align: left; padding: 12px; color: #555; }
    .excel-table td { padding: 10px 12px; border-bottom: 1px solid #eee; }
    .excel-table tr:hover { background: #fcfcfc; }
    .numeric { text-align: right; font-family: monospace; font-size: 1.1em; }

    .action-bar { margin-bottom: 15px; display: flex; justify-content: flex-end; gap: 10px; }
    .btn-icon { padding: 5px 8px; border-radius: 4px; color: #555; background: #f4f4f4; }
    .danger { color: #d9534f !important; }

    /* P√âNZ√úGYI K√ÅRTY√ÅK */
    .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .sum-card { background: #fff; padding: 20px; border-radius: 8px; border: 1px solid var(--border); border-top: 4px solid #ccc; }
    .sum-card h3 { margin: 0 0 10px 0; font-size: 12px; color: #666; text-transform: uppercase; }
    .sum-card .value { font-size: 22px; font-weight: bold; color: #333; }
    .sc-blue { border-top-color: var(--primary); } .sc-red { border-top-color: #d9534f; } .sc-green { border-top-color: #28a745; }
</style>
{% endblock %}

{% block content %}

    <div class="project-header">
        <div>
            <h1>{{ project.name }} <span class="badge">{{ project.get_status_display }}</span></h1>
            <div class="project-meta">
                <span><i class="fa-solid fa-location-dot"></i> {{ project.location }}</span>
                <span><i class="fa-solid fa-user"></i> {{ project.contact_name|default:project.client }}</span>
            </div>
        </div>
        <div style="display: flex; gap: 10px;">
            <a href="{% url 'gantt-view' project.id %}" class="btn btn-sm btn-secondary" style="background-color: #6f42c1; color: white;">Gantt</a>
            {% if perms.projects.view_expense %}
                <a href="{% url 'project-quote-html' project.id %}" class="btn btn-sm btn-primary" target="_blank">Nyomtat√°s</a>
            {% endif %}
            <a href="{% url 'project-update' project.id %}" class="btn btn-sm btn-secondary">Szerkeszt√©s</a>
        </div>
    </div>

    <div class="pipeline">
        {% for code, label in all_statuses %}
            {% if code != 'ELUTASITVA' %}
                <a href="{% url 'project-status-update' project.id code %}" class="step {% if project.status == code %}active{% endif %}">
                    {% if project.status == code %}‚óè{% endif %} {{ label }}
                </a>
            {% endif %}
        {% endfor %}
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="openTab(event, 'overview')">üìä √Åttekint√©s</button>
        {% if perms.projects.view_tetelsor %}<button class="tab-btn" onclick="openTab(event, 'budget')">üß± K√∂lts√©gvet√©s</button>{% endif %}
        {% if perms.projects.view_materialorder %}<button class="tab-btn" onclick="openTab(event, 'orders')">üì¶ Anyagrendel√©s</button>{% endif %}
        <button class="tab-btn" onclick="openTab(event, 'inventory')">üèóÔ∏è Rakt√°r</button>
        <button class="tab-btn" onclick="openTab(event, 'documents')">üìÇ Dokumentumok</button>
        <button class="tab-btn" onclick="openTab(event, 'logs')">üìã Napl√≥</button>
    </div>

    <div id="overview" class="tab-content active">
        <div class="summary-grid">
            {% if perms.projects.view_expense %}
                <div class="sum-card sc-blue"><h3>Tervezett</h3><div class="value">{{ plan_total|floatformat:0|intcomma }} Ft</div></div>
                <div class="sum-card sc-red"><h3>Kiad√°s</h3><div class="value">{{ actual_total|floatformat:0|intcomma }} Ft</div></div>
                <div class="sum-card sc-green"><h3>Egyenleg</h3><div class="value">{{ balance|floatformat:0|intcomma }} Ft</div></div>
            {% else %}
                <div class="sum-card"><h3>Inf√≥</h3><div class="value">Adatok rejtve</div></div>
            {% endif %}
            <div class="sum-card"><h3>Munka√≥ra</h3><div class="value">{{ total_effort_hours|floatformat:0 }} √≥ra</div></div>
        </div>

        {% if perms.projects.view_expense %}
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3>Kiad√°sok</h3>
                <a href="{% url 'expense-create' project.id %}" class="btn btn-sm btn-danger">+ √öj Kiad√°s</a>
            </div>
            <table class="excel-table">
                <thead><tr><th>D√°tum</th><th>T√©tel</th><th>√ñsszeg</th><th>F√°jl</th></tr></thead>
                <tbody>
                    {% for e in expenses|slice:":5" %}
                    <tr>
                        <td>{{ e.date|date:"Y.m.d" }}</td><td>{{ e.name }}</td>
                        <td class="numeric">{{ e.amount_netto|floatformat:0|intcomma }} Ft</td>
                        <td>{% if e.invoice_file %}<a href="{{ e.invoice_file.url }}" target="_blank">Megtekint√©s</a>{% endif %}</td>
                    </tr>
                    {% empty %}<tr><td colspan="4" style="text-align:center;">Nincsenek kiad√°sok.</td></tr>{% endfor %}
                </tbody>
            </table>
        {% endif %}
    </div>

    {% if perms.projects.view_tetelsor %}
    <div id="budget" class="tab-content">
        <div class="action-bar">
            <a href="{% url 'import-tasks' project.id %}" class="btn btn-sm btn-secondary">Excel Import</a>
            <a href="{% url 'tetelsor-create-master-step1' project.id %}" class="btn btn-sm btn-success">+ √öj T√©tel</a>
        </div>
        <div class="table-responsive">
            <table class="excel-table">
                <thead>
                    <tr>
                        <th>K√≥d</th>
                        <th>Le√≠r√°s</th>
                        <th>Menny.</th>
                        <th>Egys√©g</th>
                        <th class="numeric">Anyag√°r</th>
                        <th class="numeric">D√≠j</th>
                        <th class="numeric">√ñsszesen</th>
                        <th style="width: 120px; text-align: center;">M≈±velet</th>
                    </tr>
                </thead>
                <tbody>
                    {% for t in tasks %}
                    <tr>
                        <td><small>{{ t.tetelszam }}</small></td>
                        <td>{{ t.leiras|truncatechars:50 }}</td>
                        <td><a href="{% url 'tetelsor-edit-quantity' t.id %}" style="font-weight:bold;">{{ t.mennyiseg }}</a></td>
                        <td>{{ t.egyseg }}</td>
                        <td class="numeric">{{ t.anyag_egysegar|floatformat:0|intcomma }}</td>
                        <td class="numeric">{{ t.dij_egysegre_sajat|add:t.dij_egysegre_alv|floatformat:0|intcomma }}</td>
                        <td class="numeric"><strong>{{ t.anyag_osszesen|add:t.sajat_munkadij_osszesen|add:t.alv_munkadij_osszesen|floatformat:0|intcomma }}</strong></td>
                        <td style="text-align: center;">
                            <a href="{% url 'tetelsor-edit' t.id %}" class="btn-icon" title="Szerkeszt√©s">‚úèÔ∏è</a>

                            {% if t.master_item %}
                            <a href="{% url 'sync-tetelsor-to-master' t.id %}"
                               class="btn-icon"
                               style="color: #005a9c; background-color: #e3f2fd;"
                               title="V√°ltoz√°sok ment√©se a K√∂zponti Adatt√∂rzsbe (Friss√≠ti az eredeti t√©telt!)"
                               onclick="return confirm('Biztosan fel√ºl√≠rod a k√∂zponti katal√≥gusban l√©v≈ë t√©telt a projekt adataival?');">
                                üíæ
                            </a>
                            {% endif %}

                            <a href="{% url 'tetelsor-delete' t.id %}" class="btn-icon danger" title="T√∂rl√©s">üóëÔ∏è</a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="8" style="text-align:center; padding:30px; color:#999;">A k√∂lts√©gvet√©s √ºres.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    {% if perms.projects.view_materialorder %}
    <div id="orders" class="tab-content">
        <div class="action-bar"><a href="{% url 'material-order-from-budget' project.id %}" class="btn btn-sm" style="background:#e67e22; color:white;">Rendel√©s K√∂lts√©gvet√©sb≈ël</a></div>
        <table class="excel-table">
            <thead><tr><th>D√°tum</th><th>Besz√°ll√≠t√≥</th><th>St√°tusz</th><th>M≈±velet</th></tr></thead>
            <tbody>
                {% for o in orders %}
                <tr>
                    <td>{{ o.date|date:"Y.m.d" }}</td><td>{{ o.supplier }}</td><td><span class="badge">{{ o.get_status_display }}</span></td>
                    <td>
                        <a href="{% url 'material-order-print' o.id %}" target="_blank">üñ®Ô∏è</a>
                        <a href="{% url 'material-order-update' o.id %}">‚úèÔ∏è</a>
                        {% if o.status != 'TELJESITVE' %}<a href="{% url 'material-order-finalize' o.id %}" style="color:green;">üí∞</a>{% endif %}
                        <a href="{% url 'material-order-delete' o.id %}" style="color:red;">üóëÔ∏è</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <div id="inventory" class="tab-content">
        <h3>Rakt√°rk√©szlet</h3>
        <table class="excel-table">
            <thead><tr><th>Anyag</th><th>K√©szlet</th><th>Egys√©g</th></tr></thead>
            <tbody>
                {% for item in inventory %}
                <tr><td>{{ item.name }}</td><td class="numeric"><strong>{{ item.quantity }}</strong></td><td>{{ item.unit }}</td></tr>
                {% empty %}<tr><td colspan="3" style="text-align:center;">√úres rakt√°r.</td></tr>{% endfor %}
            </tbody>
        </table>
    </div>

    <div id="documents" class="tab-content">
        <div class="action-bar"><a href="{% url 'document-create' project.id %}" class="btn btn-sm btn-primary">Felt√∂lt√©s</a></div>
        <table class="excel-table">
            <thead><tr><th>F√°jl</th><th>T√≠pus</th><th>D√°tum</th><th></th></tr></thead>
            <tbody>
                {% for d in documents %}
                <tr>
                    <td><a href="{{ d.file.url }}" target="_blank">{{ d.description|default:d.file.name }}</a></td>
                    <td>{{ d.get_category_display }}</td><td>{{ d.uploaded_at|date:"Y.m.d" }}</td>
                    <td><form method="POST" action="{% url 'document-delete' d.id %}" style="display:inline;" onsubmit="return confirm('T√∂rl√∂d?');">{% csrf_token %}<button type="submit" style="color:red; border:none; background:none; cursor:pointer;">üóëÔ∏è</button></form></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div id="logs" class="tab-content">
        <div class="action-bar">
            <a href="{% url 'daily-log-create' project.id %}" class="btn btn-sm btn-primary">üìã √öj Bejegyz√©s</a>
        </div>
        <table class="excel-table">
            <thead>
                <tr>
                    <th>D√°tum</th>
                    <th>Id≈ëj√°r√°s</th>
                    <th>L√©tsz√°m</th>
                    <th>Munka le√≠r√°sa</th>
                    <th style="width: 100px; text-align: center;">M≈±velet</th>
                </tr>
            </thead>
            <tbody>
                {% for l in project.daily_logs.all %}
                <tr>
                    <td><strong>{{ l.date|date:"Y.m.d" }}</strong></td>
                    <td>{{ l.get_weather_display }}</td>
                    <td>{{ l.workforce }} f≈ë</td>
                    <td>{{ l.work_done|linebreaksbr|truncatechars:80 }}</td>
                    <td style="text-align:center;">
                        <a href="{% url 'daily-log-update' l.id %}" class="btn-icon" title="Szerkeszt√©s" style="text-decoration:none; margin-right:5px;">
                            ‚úèÔ∏è
                        </a>
                        <a href="{% url 'daily-log-delete' l.id %}" class="btn-icon danger" title="T√∂rl√©s" style="text-decoration:none;">
                            üóëÔ∏è
                        </a>
                    </td>
                </tr>
                {% empty %}
                <tr><td colspan="5" style="text-align:center; padding:30px; color:#999;">Nincsenek napl√≥bejegyz√©sek.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

{% endblock %}

{% block extra_js %}
<script>
    function openTab(evt, tabName) {
        var i, tabcontent, tablinks;
        tabcontent = document.getElementsByClassName("tab-content");
        for (i = 0; i < tabcontent.length; i++) { tabcontent[i].classList.remove("active"); }
        tablinks = document.getElementsByClassName("tab-btn");
        for (i = 0; i < tablinks.length; i++) { tablinks[i].classList.remove("active"); }
        document.getElementById(tabName).classList.add("active");
        evt.currentTarget.classList.add("active");
    }
</script>
{% endblock %}