{% extends 'projects/base.html' %}
{% load humanize %}

{% block title %}{{ project.name }} - Projekt Adatlap{% endblock %}

{% block breadcrumbs %}
    <a href="{% url 'project-list' %}">Projektek</a> / <span>{{ project.name }}</span>
{% endblock %}

{% block extra_css %}
<style>
    /* --- 1. F≈ê ELRENDEZ√âS --- */
    .fixed-layout-container {
        display: flex;
        flex-direction: column;
        height: 85vh;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        overflow: hidden;
        border: 1px solid #ddd;
        margin-bottom: 20px;
    }

    /* --- 2. FIX FELS≈ê R√âSZ --- */
    .layout-header {
        flex: 0 0 auto;
        background-color: #fff;
        border-bottom: 1px solid #ddd;
        z-index: 20;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }

    .project-header-top {
        display: flex; justify-content: space-between; align-items: flex-start;
        padding: 20px 25px 10px 25px;
    }
    .project-title h1 { margin: 0; font-size: 22px; color: #005a9c; }
    .project-meta { color: #666; font-size: 13px; margin-top: 5px; display: flex; gap: 15px; align-items: center; }
    .badge { background: #e9ecef; color: #555; padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; text-transform: uppercase; }

    .pipeline {
        display: flex; margin: 10px 25px; background: #fff; border: 1px solid #e1e4e8;
        border-radius: 6px; overflow: hidden;
    }
    .step {
        flex: 1; padding: 8px; text-align: center; font-size: 11px; background: #f8f9fa;
        color: #6c757d; text-decoration: none; border-right: 1px solid #fff;
        display: flex; justify-content: center; align-items: center; transition: background 0.2s;
    }
    .step:last-child { border-right: none; }
    .step:hover { background: #e9ecef; }
    .step.active { background-color: #005a9c; color: white; font-weight: bold; }

    .tabs {
        display: flex; gap: 5px; padding: 0 25px; margin-top: 5px;
        background: #f8f9fa; border-top: 1px solid #eee;
    }
    .tab-btn {
        padding: 12px 20px; cursor: pointer; background: transparent; border: none;
        font-size: 14px; font-weight: 600; color: #6c757d; border-bottom: 3px solid transparent;
        transition: all 0.2s;
    }
    .tab-btn:hover { color: #005a9c; background-color: rgba(0,90,156,0.05); }
    .tab-btn.active { color: #005a9c; border-bottom-color: #005a9c; background: #fff; border-radius: 4px 4px 0 0; }

    /* --- 3. TARTALOM (A f√ºlek kont√©nere) --- */
    .layout-content {
        flex: 1 1 auto;
        overflow-y: auto; /* Ez g√∂rgeti mag√°t a tab-tartalmat is, ha kell */
        padding: 20px;
        background-color: #fff;
        position: relative;
        min-height: 0;
    }

    .tab-content { display: none; animation: fadeIn 0.3s ease-in-out; height: 100%; display: flex; flex-direction: column; }
    /* Fontos: display: flex lett a tab-content, hogy a bels≈ë elemek kit√∂lts√©k a helyet */

    .tab-content.active { display: flex; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    /* --- 4. G√ñRGETHET≈ê T√ÅBL√ÅZAT DOBOZ (UNIVERZ√ÅLIS) --- */
    .scrollable-table-box {
        flex: 1; /* Kit√∂lti a rendelkez√©sre √°ll√≥ helyet a f√ºl√∂n bel√ºl */
        overflow-y: auto; /* Bels≈ë g√∂rget√©s */
        border: 1px solid #ccc;
        border-radius: 4px;
        box-shadow: inset 0 0 10px rgba(0,0,0,0.05);
        max-height: 600px; /* Biztons√°gi maximum */
        min-height: 300px;
    }

    /* T√ÅBL√ÅZAT ST√çLUSOK */
    .excel-table { width: 100%; border-collapse: collapse; background: #fff; font-size: 13px; }

    /* RAGAD√ìS FEJL√âC (Sticky Header) */
    .excel-table th {
        position: sticky;
        top: 0;
        background: #e9ecef;
        z-index: 5;
        text-align: left; padding: 12px; color: #555; font-weight: 600;
        border-bottom: 2px solid #bbb;
        box-shadow: 0 2px 2px -1px rgba(0,0,0,0.1);
    }

    .excel-table td { padding: 10px 12px; border-bottom: 1px solid #eee; vertical-align: middle; }
    .excel-table tr:hover { background: #fcfcfc; }
    .numeric { text-align: right; font-family: monospace; font-size: 1.1em; }

    /* GOMBOK */
    .btn-sm { padding: 6px 12px; font-size: 13px; border-radius: 4px; text-decoration: none; display: inline-block; cursor: pointer; border: none; font-weight: bold;}
    .btn-primary { background: #005a9c; color: white; }
    .btn-secondary { background: #6c757d; color: white; }
    .btn-success { background: #28a745; color: white; }
    .btn-danger { background: #dc3545; color: white; }
    .btn-icon { padding: 5px 8px; border-radius: 4px; background: #f4f4f4; color: #333; text-decoration: none; }
    .btn-icon:hover { background: #e2e6ea; }

    /* P√âNZ√úGYI K√ÅRTY√ÅK (√Åttekint√©s f√ºlh√∂z) */
    .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; flex: 0 0 auto; }
    .sum-card { background: #fff; padding: 15px; border-radius: 8px; border: 1px solid #e1e4e8; border-top: 4px solid #ccc; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .sum-card h3 { margin: 0 0 5px 0; font-size: 11px; color: #666; text-transform: uppercase; }
    .sum-card .value { font-size: 20px; font-weight: bold; color: #333; }
    .sc-blue { border-top-color: #005a9c; }
    .sc-red { border-top-color: #d9534f; }
    .sc-green { border-top-color: #28a745; }
</style>
{% endblock %}

{% block content %}

<div class="fixed-layout-container">

    <div class="layout-header">
        <div class="project-header-top">
            <div class="project-title">
                <h1>{{ project.name }} <span class="badge">{{ project.get_status_display }}</span></h1>
                <div class="project-meta">
                    <span>üìç {{ project.location }}</span>
                    <span>üë§ {{ project.contact_name|default:project.client }}</span>
                    {% if project.start_date %}<span>üìÖ Start: {{ project.start_date|date:"Y.m.d" }}</span>{% endif %}
                </div>
            </div>
            <div style="display: flex; gap: 8px;">
                <a href="{% url 'gantt-view' project.id %}" class="btn-sm btn-secondary" style="background:#6f42c1;">üìä Gantt</a>
                <a href="{% url 'project-quote-html' project.id %}" class="btn-sm btn-primary" target="_blank">üñ®Ô∏è Nyomtat√°s</a>
                <a href="{% url 'project-update' project.id %}" class="btn-sm btn-secondary">‚úèÔ∏è Szerk.</a>
            </div>
        </div>

        <div class="pipeline">
            {% for code, label in all_statuses %}
                {% if code != 'ELUTASITVA' %}
                    <a href="{% url 'project-status-update' project.id code %}" class="step {% if project.status == code %}active{% endif %}">
                        {% if project.status == code %}‚óè{% endif %} {{ label }}
                    </a>
                {% endif %}
            {% endfor %}
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="openTab(event, 'overview')">üìä √Åttekint√©s</button>
            <button class="tab-btn" onclick="openTab(event, 'budget')">üß± K√∂lts√©gvet√©s</button>
            <button class="tab-btn" onclick="openTab(event, 'orders')">üì¶ Anyagrendel√©s</button>
            <button class="tab-btn" onclick="openTab(event, 'inventory')">üèóÔ∏è Rakt√°r</button>
            <button class="tab-btn" onclick="openTab(event, 'documents')">üìÇ Dokumentumok</button>
            <button class="tab-btn" onclick="openTab(event, 'logs')">üìã Napl√≥</button>
        </div>
    </div>

    <div class="layout-content">

        <div id="overview" class="tab-content active">
            <div class="summary-grid">
                <div class="sum-card sc-blue"><h3>Tervezett</h3><div class="value">{{ plan_total|floatformat:0|intcomma }} Ft</div></div>
                <div class="sum-card sc-red"><h3>Kiad√°s</h3><div class="value">{{ actual_total|floatformat:0|intcomma }} Ft</div></div>
                <div class="sum-card sc-green"><h3>Egyenleg</h3><div class="value" style="color: {% if balance >= 0 %}#28a745{% else %}#d9534f{% endif %}">{{ balance|floatformat:0|intcomma }} Ft</div></div>
                <div class="sum-card"><h3>Munka√≥ra</h3><div class="value">{{ total_effort_hours|floatformat:0 }} √≥ra</div></div>
            </div>

            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h3 style="margin:0; color:#444;">Legut√≥bbi Kiad√°sok</h3>
                <a href="{% url 'expense-create' project.id %}" class="btn-sm btn-danger">+ √öj Kiad√°s</a>
            </div>

            <div class="scrollable-table-box">
                <table class="excel-table">
                    <thead><tr><th>D√°tum</th><th>Megnevez√©s</th><th>Kateg√≥ria</th><th class="numeric">√ñsszeg</th><th>M≈±velet</th></tr></thead>
                    <tbody>
                        {% for e in expenses|slice:":10" %}
                        <tr>
                            <td>{{ e.date|date:"Y.m.d" }}</td><td>{{ e.name }}</td><td>{{ e.get_category_display }}</td>
                            <td class="numeric">{{ e.amount_netto|floatformat:0|intcomma }} Ft</td>
                            <td><a href="{% url 'expense-update' e.id %}" class="btn-icon">‚úèÔ∏è</a></td>
                        </tr>
                        {% empty %}<tr><td colspan="5" style="text-align:center; padding:20px;">Nincsenek r√∂gz√≠tett kiad√°sok.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div id="budget" class="tab-content">
            <div style="text-align:right; margin-bottom:10px;">
                <a href="{% url 'import-tasks' project.id %}" class="btn-sm btn-secondary">üìó Excel Import</a>
                <a href="{% url 'project-chapter-create' project.id %}" class="btn-sm" style="background:#6610f2; color:white;">üìÇ √öj Fejezet</a>
                <a href="{% url 'tetelsor-create-master-step1' project.id %}" class="btn-sm btn-success">+ √öj T√©tel</a>
            </div>

            <div class="scrollable-table-box">
                <table class="excel-table">
                    <thead>
                        <tr>
                            <th>K√≥d</th><th>Le√≠r√°s</th><th>Menny.</th><th>Egys√©g</th>
                            <th class="numeric">Egys√©g√°r</th><th class="numeric">V√©g√∂sszeg</th><th style="text-align:center;">M≈±velet</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for t in tasks %}
                        <tr {% if t.chapter %}style="background:#f9f9ff;"{% endif %}>
                            <td><small>{{ t.tetelszam }}</small></td>
                            <td>
                                {% if t.chapter %}<span style="color:#6610f2; font-weight:bold; font-size:0.8em;">[{{ t.chapter.name }}]</span><br>{% endif %}
                                {{ t.leiras|truncatechars:80 }}
                            </td>
                            <td><a href="{% url 'tetelsor-edit-quantity' t.id %}" style="font-weight:bold; color:#333;">{{ t.mennyiseg }}</a></td>
                            <td>{{ t.egyseg }}</td>
                            <td class="numeric">{{ t.anyag_egysegar|floatformat:0|intcomma }}</td>
                            <td class="numeric"><strong>{{ t.anyag_osszesen|add:t.sajat_munkadij_osszesen|add:t.alv_munkadij_osszesen|floatformat:0|intcomma }}</strong></td>
                            <td style="text-align: center; white-space: nowrap;">
                                <a href="{% url 'tetelsor-edit' t.id %}" class="btn-icon">‚úèÔ∏è</a>
                                {% if t.master_item %}
                                <a href="{% url 'sync-tetelsor-to-master' t.id %}" class="btn-icon" style="color:#005a9c;" title="Ment√©s t√∂rzsbe" onclick="return confirm('Fel√ºl√≠rod a t√∂rzset?');">üíæ</a>
                                {% endif %}
                                <form method="POST" action="{% url 'tetelsor-delete' t.id %}" style="display:inline;" onsubmit="return confirm('T√∂rl√∂d?');">{% csrf_token %}<button class="btn-icon" style="color:red; border:none; cursor:pointer;">üóëÔ∏è</button></form>
                            </td>
                        </tr>
                        {% empty %}<tr><td colspan="7" style="text-align:center; padding:30px; color:#999;">√úres k√∂lts√©gvet√©s.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div id="orders" class="tab-content">
            <div style="text-align:right; margin-bottom:10px;">
                <a href="{% url 'material-order-create' project.id %}" class="btn-sm btn-secondary">√úres Rendel√©s</a>
                <a href="{% url 'material-order-from-budget' project.id %}" class="btn-sm" style="background:#e67e22; color:white;">Rendel√©s K√∂lts√©gvet√©sb≈ël</a>
            </div>

            <div class="scrollable-table-box">
                <table class="excel-table">
                    <thead><tr><th>D√°tum</th><th>Besz√°ll√≠t√≥</th><th>St√°tusz</th><th>M≈±velet</th></tr></thead>
                    <tbody>
                        {% for o in orders %}
                        <tr>
                            <td>{{ o.date|date:"Y.m.d" }}</td><td>{{ o.supplier|default:"-" }}</td>
                            <td><span class="badge" style="background:{% if o.status == 'TELJESITVE' %}#d4edda{% else %}#fff3cd{% endif %};">{{ o.get_status_display }}</span></td>
                            <td>
                                <a href="{% url 'material-order-print' o.id %}" target="_blank" class="btn-icon">üñ®Ô∏è</a>
                                <a href="{% url 'material-order-update' o.id %}" class="btn-icon">‚úèÔ∏è</a>
                                {% if o.status != 'TELJESITVE' %}<a href="{% url 'material-order-finalize' o.id %}" class="btn-icon" style="color:green;">üí∞</a>{% endif %}
                                <form method="POST" action="{% url 'material-order-delete' o.id %}" style="display:inline;" onsubmit="return confirm('T√∂rl√∂d?');">{% csrf_token %}<button class="btn-icon" style="color:red; border:none; cursor:pointer;">üóëÔ∏è</button></form>
                            </td>
                        </tr>
                        {% empty %}<tr><td colspan="4" style="text-align:center; color:#999;">Nincs rendel√©s.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div id="inventory" class="tab-content">
            <div class="scrollable-table-box">
                <table class="excel-table">
                    <thead><tr><th>Anyag Neve</th><th class="numeric">K√©szlet</th><th>Egys√©g</th><th>Utols√≥ mozg√°s</th></tr></thead>
                    <tbody>
                        {% for item in inventory %}
                        <tr><td>{{ item.name }}</td><td class="numeric" style="font-weight:bold;">{{ item.quantity }}</td><td>{{ item.unit }}</td><td style="color:#888;">{{ item.last_updated|date:"Y.m.d H:i" }}</td></tr>
                        {% empty %}<tr><td colspan="4" style="text-align:center; padding:20px;">√úres rakt√°r.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div id="documents" class="tab-content">
            <div style="text-align:right; margin-bottom:10px;">
                <a href="{% url 'document-create' project.id %}" class="btn-sm btn-primary">+ Dokumentum Felt√∂lt√©se</a>
            </div>

            <div class="scrollable-table-box">
                <table class="excel-table">
                    <thead><tr><th>F√°jl</th><th>Kateg√≥ria</th><th>Le√≠r√°s</th><th>D√°tum</th><th></th></tr></thead>
                    <tbody>
                        {% for d in documents %}
                        <tr>
                            <td><a href="{{ d.file.url }}" target="_blank" style="font-weight:bold; color:#005a9c;">üìÑ {{ d.file.name|truncatechars:30 }}</a></td>
                            <td>{{ d.get_category_display }}</td><td>{{ d.description }}</td><td>{{ d.uploaded_at|date:"Y.m.d" }}</td>
                            <td><form method="POST" action="{% url 'document-delete' d.id %}" style="display:inline;" onsubmit="return confirm('T√∂rl√∂d?');">{% csrf_token %}<button class="btn-icon" style="color:red; border:none; cursor:pointer;">üóëÔ∏è</button></form></td>
                        </tr>
                        {% empty %}<tr><td colspan="5" style="text-align:center; color:#999;">Nincs dokumentum.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div id="logs" class="tab-content">
            <div style="text-align:right; margin-bottom:10px;">
                <a href="{% url 'daily-log-create' project.id %}" class="btn-sm btn-primary">üìù √öj Bejegyz√©s</a>
            </div>

            <div class="scrollable-table-box">
                <table class="excel-table">
                    <thead><tr><th>D√°tum</th><th>Id≈ëj√°r√°s</th><th>L√©tsz√°m</th><th>Munka</th><th style="text-align:center;">M≈±velet</th></tr></thead>
                    <tbody>
                        {% for l in project.daily_logs.all %}
                        <tr>
                            <td><a href="{% url 'daily-log-detail' l.id %}" style="font-weight:bold; color:#005a9c; text-decoration:underline;">{{ l.date|date:"Y.m.d (l)" }}</a></td>
                            <td>{{ l.get_weather_display }}</td><td>{{ l.workforce }} f≈ë</td><td>{{ l.work_done|truncatechars:50 }}</td>
                            <td style="text-align:center;">
                                <a href="{% url 'daily-log-update' l.id %}" class="btn-icon">‚úèÔ∏è</a>
                                <form method="POST" action="{% url 'daily-log-delete' l.id %}" style="display:inline;" onsubmit="return confirm('T√∂rl√∂d?');">{% csrf_token %}<button class="btn-icon" style="color:red; border:none; cursor:pointer;">üóëÔ∏è</button></form>
                            </td>
                        </tr>
                        {% empty %}<tr><td colspan="5" style="text-align:center; color:#999;">Nincs bejegyz√©s.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    function openTab(evt, tabName) {
        var i, tabcontent, tablinks;
        tabcontent = document.getElementsByClassName("tab-content");
        for (i = 0; i < tabcontent.length; i++) {
            tabcontent[i].classList.remove("active");
            tabcontent[i].style.display = "none"; // Biztos, ami biztos
        }
        tablinks = document.getElementsByClassName("tab-btn");
        for (i = 0; i < tablinks.length; i++) { tablinks[i].classList.remove("active"); }

        var activeTab = document.getElementById(tabName);
        activeTab.style.display = "flex"; // Flex kell a layout miatt
        activeTab.classList.add("active");

        if (evt) { evt.currentTarget.classList.add("active"); }
        else {
            var btn = document.querySelector(`button[onclick="openTab(event, '${tabName}')"]`);
            if(btn) btn.classList.add("active");
        }
    }

    document.addEventListener("DOMContentLoaded", function() {
        var hash = window.location.hash.substring(1);
        if (hash) {
            var targetTab = document.getElementById(hash);
            if (targetTab && targetTab.classList.contains("tab-content")) {
                openTab(null, hash);
            }
        } else {
            // Alap√©rtelmezett f√ºl (Overview) megnyit√°sa
            openTab(null, 'overview');
        }
    });
</script>
{% endblock %}