{% load humanize %}

<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <title>{{ project.name }} - R√©szletek</title>

    <style>
        body { font-family: sans-serif; margin: 2em; background-color: #f4f4f4; }
        h1, h2 { color: #333; border-bottom: 2px solid #005a9c; padding-bottom: 5px; }
        .details { background-color: #fff; border: 1px solid #ddd; border-radius: 5px; padding: 15px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .meta { font-size: 1.1em; line-height: 1.6; }

        .back-link { display: inline-block; margin-bottom: 15px; text-decoration: none; color: #005a9c; font-weight: bold; }

        .deletion-warning { background-color: #fcf8e3; border: 1px solid #fae29f; color: #8a6d3b; padding: 15px; border-radius: 5px; font-weight: bold; text-align: center; margin-bottom: 15px; }

        .button-container { margin-bottom: 15px; display: flex; flex-wrap: wrap; gap: 10px; }
        .button { display: inline-block; color: white; padding: 8px 12px; text-decoration: none; border-radius: 5px; font-weight: bold; font-size: 0.9em; cursor: pointer; border: none; }
        .btn-edit { background-color: #f0ad4e; } .btn-delete { background-color: #d9534f; } .btn-import { background-color: #5cb85c; }
        .btn-print { background-color: #31708f; } .btn-expense { background-color: #d9534f; } .btn-log { background-color: #31708f; }
        .btn-gantt { background-color: #8e44ad; }

        .excel-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 0.9em; background-color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .excel-table th, .excel-table td { border: 1px solid #ddd; padding: 8px 10px; text-align: left; word-break: break-word; }
        .excel-table thead th { background-color: #f2f2f2; font-weight: bold; color: #333; position: sticky; top: 0; }
        .excel-table tbody tr:nth-child(even) { background-color: #f9f9f9; }
        .excel-table td.numeric { text-align: right; font-family: monospace; white-space: nowrap; }

        .excel-table td.editable a { display: block; text-decoration: none; color: #005a9c; font-weight: bold; white-space: nowrap; }
        .excel-table td.editable a:hover { background-color: #f0f8ff; }

        .excel-table td.actions { text-align: center; white-space: nowrap; }
        .excel-table td.actions a { text-decoration: none; padding: 4px; font-size: 1.1em; }

        .summary-box { background-color: #fff; border: 2px solid #005a9c; border-radius: 5px; padding: 15px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .summary-box h2 { margin-top: 0; border-bottom: none; color: #005a9c; }
        .summary-box p { font-size: 1.1em; margin: 10px 0; overflow: hidden; }
        .summary-box p span { font-weight: bold; float: right; color: #333; font-family: monospace; }
        .summary-box hr { border: 0; border-top: 1px solid #ddd; margin: 15px 0; }
        .summary-box p.total { font-size: 1.3em; font-weight: bold; }
        .summary-box p.total span { color: #005a9c; font-size: 1.1em; }

        .comparison-box { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
        .summary-col { flex: 1; background-color: #fff; border: 1px solid #ddd; border-radius: 5px; padding: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); min-width: 250px; }
        .summary-col h3 { margin-top: 0; font-size: 1.2em; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .summary-col p { font-size: 1.1em; margin: 8px 0; overflow: hidden; }
        .summary-col p span { font-weight: bold; float: right; color: #333; font-family: monospace; }

        .col-plan { border-top: 4px solid #005a9c; }
        .col-actual { border-top: 4px solid #d9534f; }
        .col-balance { border-top: 4px solid #5cb85c; }
        .balance-positive { color: #5cb85c !important; }
        .balance-negative { color: #d9534f !important; }

        @media print {
            body { margin: 0; background-color: #fff; }
            .no-print, .back-link { display: none !important; }
            .details, .summary-box, .excel-table, .summary-col { box-shadow: none; border: 1px solid #ccc; }
            h1, h2 { border: none; }
            .comparison-box { display: block; }
            .summary-col { margin-bottom: 10px; page-break-inside: avoid; }
            .excel-table td.actions, .excel-table th.actions { display: none; }
            .excel-table td.editable a { text-decoration: none; color: black; }
        }
    </style>
</head>
<body>
    {% if messages %}
        <div style="margin-bottom: 20px;">
            {% for message in messages %}
                <div style="padding: 15px; margin-bottom: 10px; border-radius: 5px; {% if message.tags == 'success' %} background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; {% elif message.tags == 'error' %} background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; {% endif %}">
                    {{ message }}
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <a href="{% url 'project-list' %}" class="back-link no-print">&laquo; Vissza a projekt list√°ra</a>

    <h1>{{ project.name }}</h1>

    <div class="button-container no-print">
        {% if project.status == 'TORLES_KERELEM' %}
            <div class="deletion-warning" style="width: 100%;">Ez a projekt t√∂rl√©sre lett jel√∂lve. Adminisztr√°tori j√≥v√°hagy√°sra v√°r.</div>
        {% else %}
            <a href="{% url 'gantt-view' project.id %}" class="button btn-gantt">üìä Gantt Diagram</a>
            <a href="{% url 'daily-log-create' project.id %}" class="button btn-log">üìã Napi Jelent√©s</a>
            <a href="{% url 'expense-create' project.id %}" class="button btn-expense">üí∏ √öj Kiad√°s</a>
            <button onclick="window.print()" class="button btn-print">üñ®Ô∏è Nyomtat√°s / PDF</button>
            <a href="{% url 'import-tasks' project.id %}" class="button btn-import">üì• Excel Import</a>
            <a href="{% url 'tetelsor-create-master-step1' project.id %}" class="button btn-import" style="background-color: #008080;">‚ûï √öj T√©tel (T√∂rzsb≈ël)</a>
            <a href="{% url 'project-update' project.id %}" class="button btn-edit">‚úé Szerkeszt√©s</a>
            <a href="{% url 'project-request-delete' project.id %}" class="button btn-delete">üóëÔ∏è T√∂rl√©s</a>
        {% endif %}
    </div>

    <div class="details">
        <p class="meta">
            <strong>Helysz√≠n:</strong> {{ project.location }} <br>
            <strong>√úgyf√©l:</strong> {{ project.client|default:"Nincs megadva" }} <br>
            <strong>St√°tusz:</strong> {{ project.get_status_display }} <br>

            <strong>Tervezett id≈ëtartam:</strong>
                {% if project.start_date %}
                    {{ project.start_date|date:"Y-m-d" }} - {{ calculated_end_date|date:"Y-m-d"|default:"N/A" }}
                    ({{ total_workdays }} munkanap)
                {% else %}
                    Nincs kezd√©si d√°tum megadva
                {% endif %}
            <br>
            <strong>Rezs√≠√≥ab√©r:</strong> {{ project.hourly_rate|floatformat:0|intcomma }} Ft/√≥ra <br>
            <strong>Tervezett munka√≥ra / nap:</strong> {{ project.hours_per_day|floatformat:2 }} √≥ra <br>
            <strong>Alkalmazott √ÅFA kulcs:</strong> {{ project.vat_rate }}%
        </p>
    </div>

    <div class="summary-box">
        <h2>P√©nz√ºgyi √ñsszegz√©s</h2>
        <p>Teljes Anyagk√∂lts√©g (Nett√≥): <span>{{ plan_anyag|floatformat:0|intcomma }} HUF</span></p>
        <p>Saj√°t Munkad√≠j (Nett√≥): <span>{{ plan_dij_sajat|floatformat:0|intcomma }} HUF</span></p>
        <p>Alv√°llalk. Munkad√≠j (Nett√≥): <span>{{ plan_dij_alv|floatformat:0|intcomma }} HUF</span></p>
        <hr>
        <p class="total">Projekt V√©g√∂sszeg (Nett√≥): <span>{{ plan_total|floatformat:0|intcomma }} HUF</span></p>
        <hr>
        <p>√ÅFA ({{ vat_rate }}%): <span>{{ total_vat|floatformat:0|intcomma }} HUF</span></p>
        <p class="total">Projekt V√©g√∂sszeg (Brutt√≥): <span>{{ total_project_brutto|floatformat:0|intcomma }} HUF</span></p>
        <hr>
        <p>Tervezett id≈ër√°ford√≠t√°s: <span>{{ total_effort_hours|floatformat:2 }} √≥ra</span></p>
    </div>

    <div class="comparison-box">
        <div class="summary-col col-plan">
            <h3>TERV (K√∂lts√©gvet√©s)</h3>
            <p>Anyag: <span>{{ plan_anyag|floatformat:0|intcomma }} Ft</span></p>
            <p>D√≠j (√ñsszes): <span>{{ plan_dij|floatformat:0|intcomma }} Ft</span></p>
            <hr>
            <p><strong>√ñsszesen: <span>{{ plan_total|floatformat:0|intcomma }} Ft</span></strong></p>
        </div>
        <div class="summary-col col-actual">
            <h3>T√âNY (Kiad√°sok)</h3>
            <p>Anyag: <span>{{ actual_anyag|floatformat:0|intcomma }} Ft</span></p>
            <p>D√≠j (Munkad√≠j): <span>{{ actual_dij|floatformat:0|intcomma }} Ft</span></p>
            <hr>
            <p><strong>√ñsszesen: <span>{{ actual_total|floatformat:0|intcomma }} Ft</span></strong></p>
        </div>
        <div class="summary-col col-balance">
            <h3>EGYENLEG (Marad√©k)</h3>
            <div style="text-align: center; font-size: 2em; margin-top: 20px; font-weight: bold;"
                 class="{% if balance >= 0 %}balance-positive{% else %}balance-negative{% endif %}">
                {{ balance|floatformat:0|intcomma }} Ft
            </div>
            <p style="text-align: center; color: #666;">(Terv - T√©ny)</p>
        </div>
    </div>

    <h2>R√∂gz√≠tett Kiad√°sok / Sz√°ml√°k</h2>
    <div style="overflow-x: auto;">
        <table class="excel-table">
            <thead>
                <tr><th>D√°tum</th><th>Megnevez√©s / Sz√°mlasz√°m</th><th>Kateg√≥ria</th><th>√ñsszeg (Nett√≥)</th><th>Sz√°mlak√©p</th><th class="actions no-print">M≈±veletek</th></tr>
            </thead>
            <tbody>
                {% for expense in expenses %}
                <tr>
                    <td>{{ expense.date|date:"Y.m.d" }}</td><td>{{ expense.name }}</td><td>{{ expense.get_category_display }}</td><td class="numeric">{{ expense.amount_netto|floatformat:0|intcomma }} Ft</td>
                    <td style="text-align: center;">{% if expense.invoice_file %}<a href="{{ expense.invoice_file.url }}" target="_blank">Megtekint√©s</a>{% else %}-{% endif %}</td>
                    <td class="actions no-print">
                        <a href="{% url 'expense-update' expense.id %}">‚úèÔ∏è</a>
                        <a href="{% url 'expense-delete' expense.id %}" style="color: red; margin-left: 5px;">üóëÔ∏è</a>
                    </td>
                </tr>
                {% empty %}<tr><td colspan="6" style="text-align: center;">M√©g nincsenek r√∂gz√≠tett kiad√°sok.</td></tr>{% endfor %}
            </tbody>
        </table>
    </div>

    <h2 style="margin-top: 30px;">K√∂lts√©gvet√©si T√©telsorok</h2>

    <form method="GET" class="no-print" style="margin-bottom: 15px;">
        <label for="munkanem">Sz≈±r√©s Munkanemre:</label>
        <select name="munkanem_filter" id="munkanem" onchange="this.form.submit()">
            <option value="">-- Minden Munkanem --</option>
            {% for m in munkanem_list %}
                <option value="{{ m.nev }}" {% if current_munkanem == m.nev %}selected{% endif %}>{{ m.nev }}</option>
            {% endfor %}
        </select>
        <noscript><button type="submit">Sz≈±r√©s</button></noscript>
    </form>

    <div style="overflow-x: auto;">
        <table class="excel-table">
            <thead>
                <tr>
                    <th>Sorsz√°m</th>
                    <th>T√©telsz√°m (B)</th>
                    <th>Le√≠r√°s (C)</th>
                    <th>Mennyis√©g (D)</th>
                    <th>Egys√©g (E)</th>
                    <th>Anyag √ñssz. (H)</th>
                    <th>Saj√°t D√≠j √ñssz.</th>

                    <th class="actions no-print">M≈±veletek</th>
                </tr>
            </thead>
            <tbody>
                {% for tetel in tasks %}
                <tr>
                    <td>
                        {{ project.start_date|date:"y"|default:"25" }}-{{ project.id|stringformat:"03d" }}-{{ forloop.counter|stringformat:"04d" }}
                    </td>

                    <td>{{ tetel.tetelszam }}</td>

                    <td>{{ tetel.leiras }}</td>

                    <td class="numeric editable">
                        <a href="{% url 'tetelsor-edit-quantity' tetel.id %}" title="Gyors m√≥dos√≠t√°s">{{ tetel.mennyiseg }}</a>
                    </td>

                    <td>{{ tetel.egyseg }}</td>

                    <td class="numeric">{{ tetel.anyag_osszesen|floatformat:0|intcomma }} HUF</td>

                    <td class="numeric">{{ tetel.sajat_munkadij_osszesen|floatformat:0|intcomma }} HUF</td>

                    <td class="actions no-print">
                        <a href="{% url 'tetelsor-edit' tetel.id %}" title="R√©szletes szerkeszt√©s">‚úèÔ∏è</a>
                        <a href="{% url 'tetelsor-delete' tetel.id %}" title="T√©telsor T√∂rl√©se" style="color: red; margin-left: 10px;">üóëÔ∏è</a>
                    </td>
                </tr>
                {% empty %}
                <tr><td colspan="8" style="text-align: center;">Nincsenek r√∂gz√≠tve t√©telsorok.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <h2 style="margin-top: 30px;">√âp√≠t√©si Napl√≥ Bejegyz√©sek</h2>
    <div style="overflow-x: auto;">
        <table class="excel-table">
            <thead><tr><th>D√°tum</th><th>Id≈ëj√°r√°s</th><th>Munkaer≈ë (f≈ë)</th><th>Elv√©gzett munka / Halad√°s</th><th>Probl√©m√°k</th><th class="actions no-print">M≈±veletek</th></tr></thead>
            <tbody>
                {% for log in project.daily_logs.all %}
                <tr>
                    <td>{{ log.date|date:"Y.m.d" }}</td><td>{{ log.get_weather_display }}</td><td class="numeric">{{ log.workforce }}</td>
                    <td>{{ log.work_done|truncatechars:100 }}</td><td>{{ log.problems|default:"-"|truncatechars:100 }}</td>
                    <td class="actions no-print">
                        <a href="{% url 'daily-log-update' log.id %}" title="Szerkeszt√©s">‚úèÔ∏è</a>
                        <a href="{% url 'daily-log-delete' log.id %}" style="color: red; margin-left: 5px;" title="T√∂rl√©s">üóëÔ∏è</a>
                    </td>
                </tr>
                {% empty %}<tr><td colspan="6" style="text-align: center;">M√©g nincsenek napi bejegyz√©sek r√∂gz√≠tve.</td></tr>{% endfor %}
            </tbody>
        </table>
    </div>

    <hr class="no-print">
</body>
</html>