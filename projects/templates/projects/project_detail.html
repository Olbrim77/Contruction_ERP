{% extends 'projects/base.html' %}
{% load humanize %}

{% block title %}{{ project.name }} - Projekt Adatlap{% endblock %}

{% block breadcrumbs %}
    <a href="{% url 'project-list' %}">Projektek</a> / <span>{{ project.name }}</span>
{% endblock %}

{% block extra_css %}
<style>
    /* --- FEJL√âC ST√çLUSOK --- */
    .project-header {
        display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px;
        background: #fff; padding: 20px; border-radius: 8px; border: 1px solid var(--border);
    }
    .project-title h1 { margin: 0; font-size: 24px; color: var(--primary); }
    .project-meta { color: #666; font-size: 14px; margin-top: 5px; display: flex; gap: 15px; align-items: center; }
    .project-meta i { color: var(--secondary); width: 16px; text-align: center; }
    .badge { background: #e9ecef; color: #555; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600; text-transform: uppercase; }

    /* --- FOLYAMATS√ÅV (PIPELINE) --- */
    .pipeline { display: flex; margin-bottom: 20px; background: #fff; border: 1px solid var(--border); border-radius: 8px; overflow: hidden; }
    .step { flex: 1; text-decoration: none; position: relative; background: #f8f9fa; color: #6c757d; padding: 12px 10px 12px 30px; font-size: 12px; font-weight: 600; display: flex; align-items: center; justify-content: center; transition: all 0.2s; white-space: nowrap; }
    .step::after { content: ''; position: absolute; top: 0; right: -14px; border: 21px solid transparent; border-left: 14px solid #f8f9fa; z-index: 2; }
    .step::before { content: ''; position: absolute; top: 0; left: 0; border: 21px solid transparent; border-left: 14px solid #fff; z-index: 1; }
    .step:first-child { padding-left: 15px; } .step:first-child::before { display: none; }
    .step:hover { background-color: #e2e6ea; color: #333; } .step:hover::after { border-left-color: #e2e6ea; }
    .step.active { background-color: var(--primary); color: white; z-index: 3; } .step.active::after { border-left-color: var(--primary); }
    .step.done { background-color: #d4edda; color: #155724; } .step.done::after { border-left-color: #d4edda; }

    /* --- F√úLEK (TABS) --- */
    .tabs { display: flex; gap: 2px; border-bottom: 2px solid #e1e4e8; margin-bottom: 20px; }
    .tab-btn {
        padding: 10px 20px; cursor: pointer; background: transparent; border: none;
        font-size: 14px; font-weight: 600; color: #6c757d; border-bottom: 3px solid transparent;
        transition: all 0.2s;
    }
    .tab-btn:hover { color: var(--primary); background-color: rgba(0,90,156,0.05); }
    .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }

    /* TARTALOM SZEKCI√ìK */
    .tab-content { display: none; animation: fadeIn 0.3s ease-in-out; }
    .tab-content.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    /* --- K√ÅRTY√ÅK --- */
    .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .sum-card { background: #fff; padding: 20px; border-radius: 8px; border: 1px solid var(--border); border-top: 4px solid #ccc; }
    .sum-card h3 { margin: 0 0 10px 0; font-size: 12px; color: #666; text-transform: uppercase; }
    .sum-card .value { font-size: 22px; font-weight: bold; color: #333; }
    .sc-blue { border-top-color: var(--primary); } .sc-red { border-top-color: #d9534f; } .sc-green { border-top-color: #28a745; }

    /* --- T√ÅBL√ÅZATOK --- */
    .excel-table { width: 100%; border-collapse: collapse; background: #fff; border: 1px solid var(--border); box-shadow: 0 2px 4px rgba(0,0,0,0.02); font-size: 13px; }
    .excel-table th { background: #f8f9fa; text-align: left; padding: 12px; color: #555; border-bottom: 2px solid #eee; font-weight: 600; }
    .excel-table td { padding: 10px 12px; border-bottom: 1px solid #eee; vertical-align: middle; }
    .excel-table tr:hover { background: #fcfcfc; }
    .numeric { text-align: right; font-family: monospace; font-size: 1.1em; }

    /* GOMBOK √âS ESZK√ñZ√ñK */
    .action-bar { margin-bottom: 15px; display: flex; justify-content: flex-end; gap: 10px; }
    .btn-icon { padding: 5px 8px; border-radius: 4px; color: #555; background: #f4f4f4; transition: 0.2s; }
    .btn-icon:hover { background: #e2e6ea; color: #333; }
    .danger { color: #d9534f !important; }
</style>
{% endblock %}

{% block content %}

    <div class="project-header">
        <div class="project-title">
            <h1>{{ project.name }} <span class="badge">{{ project.get_status_display }}</span></h1>
            <div class="project-meta">
                <span><i class="fa-solid fa-location-dot"></i> {{ project.location }}</span>
                <span><i class="fa-solid fa-user"></i> {{ project.contact_name|default:project.client }}</span>
                {% if project.start_date %}<span><i class="fa-regular fa-calendar"></i> {{ project.start_date|date:"Y.m.d" }} - {{ calculated_end_date|date:"Y.m.d"|default:"?" }}</span>{% endif %}
            </div>
        </div>
        <div style="display: flex; gap: 10px;">
            <a href="{% url 'gantt-view' project.id %}" class="btn btn-sm btn-secondary" style="background-color: #6f42c1; color: white;"><i class="fa-solid fa-chart-gantt"></i> Gantt</a>

            {% if perms.projects.view_expense %}
                <a href="{% url 'project-quote-html' project.id %}" class="btn btn-sm btn-primary" target="_blank"><i class="fa-solid fa-print"></i> Nyomtat√°s</a>
            {% endif %}

            <a href="{% url 'project-update' project.id %}" class="btn btn-sm btn-secondary"><i class="fa-solid fa-pen"></i> Szerkeszt√©s</a>
        </div>
    </div>

    <div class="pipeline">
        {% for code, label in all_statuses %}
            {% if code != 'ELUTASITVA' %}
                <a href="{% url 'project-status-update' project.id code %}" class="step {% if project.status == code %}active{% endif %}" title="{{ label }}">
                    {% if project.status == code %}<i class="fa-solid fa-circle-dot"></i>&nbsp;{% endif %} {{ label }}
                </a>
            {% endif %}
        {% endfor %}
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="openTab(event, 'overview')">üìä √Åttekint√©s</button>

        {% if perms.projects.view_tetelsor %}
            <button class="tab-btn" onclick="openTab(event, 'budget')">üß± K√∂lts√©gvet√©s</button>
        {% endif %}

        {% if perms.projects.view_materialorder %}
            <button class="tab-btn" onclick="openTab(event, 'orders')">üì¶ Anyagrendel√©s</button>
        {% endif %}

        <button class="tab-btn" onclick="openTab(event, 'documents')">üìÇ Dokumentumok</button>
        <button class="tab-btn" onclick="openTab(event, 'logs')">üìã Napl√≥</button>
    </div>

    <div id="overview" class="tab-content active">
        <div class="summary-grid">
            {% if perms.projects.view_expense %}
                <div class="sum-card sc-blue"><h3>Tervezett K√∂lts√©g (Nett√≥)</h3><div class="value">{{ plan_total|floatformat:0|intcomma }} Ft</div></div>
                <div class="sum-card sc-red"><h3>Val√≥s Kiad√°s (Nett√≥)</h3><div class="value">{{ actual_total|floatformat:0|intcomma }} Ft</div></div>
                <div class="sum-card sc-green"><h3>Egyenleg</h3><div class="value" style="color: {% if balance >= 0 %}#28a745{% else %}#d9534f{% endif %}">{{ balance|floatformat:0|intcomma }} Ft</div></div>
            {% else %}
                <div class="sum-card"><h3>Inform√°ci√≥</h3><div class="value">P√©nz√ºgyi adatok rejtve</div></div>
            {% endif %}
            <div class="sum-card"><h3>Munka√≥ra Terv</h3><div class="value">{{ total_effort_hours|floatformat:0 }} √≥ra</div></div>
        </div>

        {% if perms.projects.view_expense %}
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin:0;">Legut√≥bbi Kiad√°sok</h3>
                <a href="{% url 'expense-create' project.id %}" class="btn btn-sm btn-danger"><i class="fa-solid fa-plus"></i> √öj Kiad√°s</a>
            </div>
            <table class="excel-table">
                <thead><tr><th>D√°tum</th><th>Megnevez√©s</th><th>Kateg√≥ria</th><th class="numeric">√ñsszeg</th><th>F√°jl</th></tr></thead>
                <tbody>
                    {% for e in expenses|slice:":5" %}
                    <tr>
                        <td>{{ e.date|date:"Y.m.d" }}</td><td>{{ e.name }}</td><td>{{ e.get_category_display }}</td>
                        <td class="numeric">{{ e.amount_netto|floatformat:0|intcomma }} Ft</td>
                        <td>
                            <a href="{% url 'expense-update' e.id %}" class="btn-icon"><i class="fa-solid fa-pen"></i></a>
                            {% if e.invoice_file %}<a href="{{ e.invoice_file.url }}" target="_blank" class="btn-icon"><i class="fa-solid fa-paperclip"></i></a>{% endif %}
                        </td>
                    </tr>
                    {% empty %}<tr><td colspan="5" style="text-align:center; color:#777;">Nincsenek kiad√°sok.</td></tr>{% endfor %}
                </tbody>
            </table>
        {% endif %}
    </div>

    {% if perms.projects.view_tetelsor %}
    <div id="budget" class="tab-content">
        <div class="action-bar">
            <a href="{% url 'import-tasks' project.id %}" class="btn btn-sm btn-secondary"><i class="fa-solid fa-file-excel"></i> Excel Import</a>
            <a href="{% url 'tetelsor-create-master-step1' project.id %}" class="btn btn-sm btn-success"><i class="fa-solid fa-plus"></i> √öj T√©tel T√∂rzsb≈ël</a>
        </div>
        <div style="overflow-x:auto;">
            <table class="excel-table">
                <thead>
                    <tr>
                        <th width="5%">#</th><th width="10%">K√≥d</th><th width="35%">Le√≠r√°s</th>
                        <th width="8%">Menny.</th><th width="5%">Egys√©g</th>
                        <th class="numeric" width="12%">Anyag√°r</th><th class="numeric" width="12%">D√≠j</th>
                        <th class="numeric" width="13%">√ñsszesen</th>
                        <th width="8%"></th>
                    </tr>
                </thead>
                <tbody>
                    {% for t in tasks %}
                    <tr>
                        <td>{{ forloop.counter }}</td><td><small>{{ t.tetelszam }}</small></td><td>{{ t.leiras|truncatechars:60 }}</td>
                        <td class="numeric" style="background:#fffce8; font-weight:bold;">
                            <a href="{% url 'tetelsor-edit-quantity' t.id %}" style="color:#333; text-decoration:none; border-bottom:1px dotted #999;">{{ t.mennyiseg }}</a>
                        </td>
                        <td>{{ t.egyseg }}</td>
                        <td class="numeric">{{ t.anyag_osszesen|floatformat:0|intcomma }}</td>
                        <td class="numeric">{{ t.sajat_munkadij_osszesen|floatformat:0|intcomma }}</td>
                        <td class="numeric"><strong>{{ t.anyag_osszesen|add:t.sajat_munkadij_osszesen|floatformat:0|intcomma }}</strong></td>
                        <td style="text-align:center;">
                            <a href="{% url 'tetelsor-edit' t.id %}" class="btn-icon"><i class="fa-solid fa-pen"></i></a>
                            <a href="{% url 'tetelsor-delete' t.id %}" class="btn-icon danger"><i class="fa-solid fa-trash"></i></a>
                        </td>
                    </tr>
                    {% empty %}<tr><td colspan="9" style="text-align:center; padding:30px; color:#999;">A k√∂lts√©gvet√©s √ºres.</td></tr>{% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    {% if perms.projects.view_materialorder %}
    <div id="orders" class="tab-content">
        <div class="action-bar">
            <a href="{% url 'material-order-from-budget' project.id %}" class="btn btn-sm" style="background:#e67e22; color:white;"><i class="fa-solid fa-boxes-stacked"></i> Rendel√©s K√∂lts√©gvet√©sb≈ël</a>
            <a href="{% url 'material-order-create' project.id %}" class="btn btn-sm btn-secondary">K√©zi Rendel√©s</a>
        </div>
        <table class="excel-table">
            <thead><tr><th>D√°tum</th><th>Besz√°ll√≠t√≥</th><th>St√°tusz</th><th style="text-align:center;">M≈±velet</th></tr></thead>
            <tbody>
                {% for o in orders %}
                <tr>
                    <td>{{ o.date|date:"Y.m.d" }}</td>
                    <td><strong>{{ o.supplier.name|default:"-" }}</strong></td>
                    <td><span class="badge">{{ o.get_status_display }}</span></td>
                    <td style="text-align:center;">
                        <a href="{% url 'material-order-print' o.id %}" target="_blank" class="btn-icon" title="Nyomtat√°s"><i class="fa-solid fa-print"></i></a>
                        <a href="{% url 'material-order-update' o.id %}" class="btn-icon" title="Szerkeszt√©s"><i class="fa-solid fa-pen"></i></a>
                        {% if o.status != 'TELJESITVE' %}<a href="{% url 'material-order-finalize' o.id %}" class="btn-icon" style="color:#28a745;" title="Sz√°mla √ârkeztet√©se"><i class="fa-solid fa-file-invoice-dollar"></i></a>{% endif %}
                        <a href="{% url 'material-order-delete' o.id %}" class="btn-icon danger" title="T√∂rl√©s"><i class="fa-solid fa-trash"></i></a>
                    </td>
                </tr>
                {% empty %}<tr><td colspan="4" style="text-align:center; padding:30px; color:#999;">Nincsenek rendel√©sek.</td></tr>{% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <div id="documents" class="tab-content">
        <div class="action-bar">
            <a href="{% url 'document-create' project.id %}" class="btn btn-sm btn-primary"><i class="fa-solid fa-upload"></i> Dokumentum Felt√∂lt√©se</a>
        </div>
        <table class="excel-table">
            <thead><tr><th width="5%"></th><th>F√°jl neve</th><th>T√≠pus</th><th>Felt√∂ltve</th><th></th></tr></thead>
            <tbody>
                {% for d in documents %}
                <tr>
                    <td style="text-align:center; font-size:1.2em;">{% if d.category == 'TERV' %}üìê{% elif d.category == 'SZERZODES' %}üìú{% elif d.category == 'FOTO' %}üì∑{% else %}üìÑ{% endif %}</td>
                    <td><a href="{{ d.file.url }}" target="_blank" style="font-weight:bold; color:var(--primary);">{{ d.description|default:d.file.name }}</a></td>
                    <td><span class="badge">{{ d.get_category_display }}</span></td><td>{{ d.uploaded_at|date:"Y.m.d H:i" }}</td>
                    <td style="text-align:right;">
                        <form method="POST" action="{% url 'document-delete' d.id %}" onsubmit="return confirm('Biztosan t√∂rl√∂d?');" style="display:inline;">{% csrf_token %}<button type="submit" class="btn-icon danger" style="border:none; cursor:pointer;"><i class="fa-solid fa-trash"></i></button></form>
                    </td>
                </tr>
                {% empty %}<tr><td colspan="5" style="text-align:center; padding:30px; color:#999;">Nincsenek dokumentumok.</td></tr>{% endfor %}
            </tbody>
        </table>
    </div>

    <div id="logs" class="tab-content">
        <div class="action-bar"><a href="{% url 'daily-log-create' project.id %}" class="btn btn-sm btn-primary">üìã √öj Bejegyz√©s</a></div>
        <table class="excel-table">
            <thead><tr><th>D√°tum</th><th>Id≈ëj√°r√°s</th><th>L√©tsz√°m</th><th>Munka</th><th></th></tr></thead>
            <tbody>
                {% for l in project.daily_logs.all %}
                <tr>
                    <td><strong>{{ l.date|date:"Y.m.d" }}</strong></td><td>{{ l.get_weather_display }}</td><td>{{ l.workforce }} f≈ë</td><td>{{ l.work_done|linebreaksbr|truncatechars:80 }}</td>
                    <td style="text-align:right;"><a href="{% url 'daily-log-update' l.id %}" class="btn-icon"><i class="fa-solid fa-pen"></i></a><a href="{% url 'daily-log-delete' l.id %}" class="btn-icon danger"><i class="fa-solid fa-trash"></i></a></td>
                </tr>
                {% empty %}<tr><td colspan="5" style="text-align:center; padding:30px; color:#999;">Nincsenek napl√≥bejegyz√©sek.</td></tr>{% endfor %}
            </tbody>
        </table>
    </div>

{% endblock %}

{% block extra_js %}
<script>
    function openTab(evt, tabName) {
        // Tartalom elrejt√©se
        var i, tabcontent, tablinks;
        tabcontent = document.getElementsByClassName("tab-content");
        for (i = 0; i < tabcontent.length; i++) { tabcontent[i].classList.remove("active"); }

        // Gombok inakt√≠vv√° t√©tele
        tablinks = document.getElementsByClassName("tab-btn");
        for (i = 0; i < tablinks.length; i++) { tablinks[i].classList.remove("active"); }

        // Kiv√°lasztott megjelen√≠t√©se
        var selectedTab = document.getElementById(tabName);
        if (selectedTab) {
            selectedTab.classList.add("active");
            evt.currentTarget.classList.add("active");
        } else {
            console.error("Tab not found: " + tabName);
        }
    }
</script>
{% endblock %}