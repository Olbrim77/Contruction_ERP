{% extends 'projects/base.html' %}

{% block title %}Jelenl√©ti √çv{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    /* --- ALAPOK --- */
    .mobile-container { max-width: 600px; margin: 0 auto; padding: 15px; background: #fff; min-height: 90vh; }

    /* Fejl√©c */
    .header-row {
        display: flex; justify-content: space-between; align-items: center;
        margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px;
    }
    .header-row h2 { margin: 0; color: #005a9c; }
    .back-link { text-decoration: none; color: #666; font-weight: bold; font-size: 0.9rem; }

    /* GPS Ikon */
    .gps-icon {
        width: 40px; height: 40px; border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        font-size: 1.2rem;
        background-color: #f8d7da; color: #dc3545; border: 2px solid #dc3545;
        transition: all 0.5s ease; animation: pulse 1.5s infinite;
    }
    .gps-icon.ok { background-color: #d4edda; color: #155724; border-color: #155724; animation: none; }
    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

    /* --- K√ÅRTY√ÅK --- */
    .card-box {
        border: 1px solid #e1e4e8; border-radius: 12px; padding: 20px;
        margin-bottom: 20px; background: #f8f9fa; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        transition: all 0.3s ease;
    }
    .hidden { display: none !important; }

    /* Inputok */
    label { display: block; font-weight: bold; margin-bottom: 8px; color: #444; }
    select, input[type="time"], input[type="number"], textarea, input[type="file"] {
        width: 100%; padding: 12px; border: 1px solid #ccc;
        border-radius: 8px; font-size: 16px; background: #fff;
        margin-bottom: 0; box-sizing: border-box; font-family: inherit;
    }

    /* St√°tusz v√°laszt√≥ */
    .status-card { background: #e3f2fd; border: 2px solid #2196f3; }
    .status-card select { font-weight: bold; color: #0d47a1; }

    /* Id≈ësor */
    .time-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
    .total-hours {
        background: #e3f2fd; color: #0d47a1; padding: 10px;
        text-align: center; border-radius: 6px; font-weight: bold; margin-bottom: 15px;
    }

    /* Checkboxok */
    .checkbox-row {
        display: flex; align-items: center; gap: 15px; margin-bottom: 10px;
        padding: 10px; background: #fff; border: 1px solid #ddd; border-radius: 8px;
    }
    input[type="checkbox"] { transform: scale(1.5); margin-left: 5px; }

    /* Valid√°ci√≥ */
    .required-highlight { border: 2px solid #dc3545 !important; background-color: #fff8f8 !important; }
    .required-label::after { content: " *"; color: #dc3545; }

    /* Gomb */
    .sticky-footer { position: sticky; bottom: 20px; margin-top: 30px; z-index: 100; }
    .btn-save {
        width: 100%; padding: 15px; background: #ccc; color: white;
        border: none; border-radius: 12px; font-size: 1.2rem; font-weight: bold;
        cursor: not-allowed; transition: background 0.3s;
    }
    .btn-save.active {
        background: #28a745; cursor: pointer;
    }
</style>
{% endblock %}

{% block content %}
<div class="mobile-container">

    <div class="header-row">
        <div>
            <a href="{% url 'mobile-dashboard' %}" class="back-link">‚¨Ö Vissza</a>
            <h2 style="margin:5px 0;">Jelenl√©ti √çv</h2>
            <small>{{ today|date:"Y.m.d (l)" }} | {{ employee.name }}</small>
        </div>
        <div id="gps-icon" class="gps-icon" title="GPS Keres√©se...">
            <i class="fa-solid fa-location-dot"></i>
        </div>
    </div>

    <form method="POST" enctype="multipart/form-data" id="attendanceForm" onsubmit="return validateForm()">
        {% csrf_token %}

        <input type="hidden" name="gps_lat" id="gps_lat">
        <input type="hidden" name="gps_lon" id="gps_lon">

        <div class="card-box status-card">
            <label><i class="fa-solid fa-list-check"></i> Mai tev√©kenys√©g</label>
            <select name="status" id="status_selector" onchange="handleStatusChange()">
                <option value="WORK" {% if attendance.status == 'WORK' %}selected{% endif %}>‚úÖ Munkav√©gz√©s t√∂rt√©nt</option>
                <option value="WEATHER" {% if attendance.status == 'WEATHER' %}selected{% endif %}>üåßÔ∏è Nem t√∂rt√©nt - Id≈ëj√°r√°s</option>
                <option value="SICK" {% if attendance.status == 'SICK' %}selected{% endif %}>ü§í Nem t√∂rt√©nt - Betegs√©g</option>
                <option value="ABSENCE" {% if attendance.status == 'ABSENCE' %}selected{% endif %}>üö® Nem t√∂rt√©nt - Rendk√≠v√ºli t√°voll√©t</option>
                <option value="OTHER" {% if attendance.status == 'OTHER' %}selected{% endif %}>‚ùì Nem t√∂rt√©nt - Egy√©b ok</option>
            </select>
        </div>

        <div id="section_work" class="card-box">
            <label>üìç Projekt</label>
            <select name="project" style="margin-bottom: 15px;">
                <option value="" disabled {% if not selected_project_id %}selected{% endif %}>-- V√°lassz projektet --</option>
                {% for p in projects %}
                    <option value="{{ p.id }}" {% if p.id == selected_project_id %}selected{% endif %}>{{ p.name }}</option>
                {% endfor %}
            </select>

            <div class="time-row">
                <div>
                    <label>Kezd√©s</label>
                    <input type="time" name="start_time" id="start_time" value="{{ attendance.start_time|time:'H:i'|default:'07:00' }}" onchange="calcHours()">
                </div>
                <div>
                    <label>Befejez√©s</label>
                    <input type="time" name="end_time" id="end_time" value="{{ attendance.end_time|time:'H:i'|default:'16:00' }}" onchange="calcHours()">
                </div>
            </div>

            <div class="total-hours" id="total-display">
                ‚è±Ô∏è Sz√°m√≠tott id≈ë: 8.0 √≥ra
            </div>

            <label class="checkbox-row">
                <input type="checkbox" name="is_driver" {% if attendance.is_driver %}checked{% endif %}>
                <span>üöó Sof≈ër p√≥tl√©k</span>
            </label>

            <label class="checkbox-row">
                <input type="checkbox" name="is_abroad" {% if attendance.is_abroad %}checked{% endif %}>
                <span>üåç K√ºlf√∂ldi munkav√©gz√©s</span>
            </label>
        </div>

        <div id="section_sick" class="card-box hidden" style="border-left: 5px solid #dc3545;">
            <label><i class="fa-solid fa-file-medical"></i> Orvosi igazol√°s felt√∂lt√©se</label>
            <input type="file" name="sick_file" accept="image/*,.pdf">
            <small style="color:#666; display:block; margin-top:5px;">Fot√≥zd le a pap√≠rt!</small>
        </div>

        <div class="card-box" id="section_note_box">
            <label id="note_label"><i class="fa-regular fa-comment-dots"></i> Megjegyz√©s</label>
            <textarea name="note" id="note" rows="3" placeholder="Opcion√°lis megjegyz√©s...">{{ attendance.note|default:'' }}</textarea>
            <small id="note_hint" style="color:#666;">√çrd le, ha b√°rmi rendk√≠v√ºli t√∂rt√©nt.</small>
        </div>

        <div id="section_finance" class="card-box" style="border-left: 5px solid #ffc107;">
            <label>üí∞ El≈ëleg k√©r√©se (Ft)</label>
            <input type="number" name="advance_amount" placeholder="0" step="1000">
        </div>

        <div class="sticky-footer">
            <button type="submit" class="btn-save" id="save-btn" disabled>
                üì° GPS Keres√©se...
            </button>
        </div>

    </form>
</div>

<script>
    // 1. GPS Logika
    document.addEventListener("DOMContentLoaded", function() {
        handleStatusChange(); // UI be√°ll√≠t√°sa indul√°skor
        calcHours();

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(gpsSuccess, gpsError, {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            });
        } else {
            alert("A b√∂ng√©sz≈ë nem t√°mogatja a GPS-t.");
            enableButtonWithoutGPS();
        }
    });

    function gpsSuccess(position) {
        document.getElementById("gps_lat").value = position.coords.latitude;
        document.getElementById("gps_lon").value = position.coords.longitude;

        var icon = document.getElementById("gps-icon");
        icon.classList.add("ok");
        icon.title = "GPS Jel OK";

        enableSaveButton("üíæ Jelenl√©t Ment√©se", "#28a745");
    }

    function gpsError(err) {
        enableButtonWithoutGPS();
    }

    function enableButtonWithoutGPS() {
        enableSaveButton("‚ö†Ô∏è Ment√©s GPS n√©lk√ºl", "#ffc107", "black");
    }

    function enableSaveButton(text, bgColor, color="white") {
        var btn = document.getElementById("save-btn");
        btn.disabled = false;
        btn.classList.add("active");
        btn.innerHTML = text;
        btn.style.backgroundColor = bgColor;
        btn.style.color = color;
    }

    // 2. UI Logika
    function handleStatusChange() {
        var status = document.getElementById("status_selector").value;

        var secWork = document.getElementById("section_work");
        var secSick = document.getElementById("section_sick");
        var secFinance = document.getElementById("section_finance");
        var noteLabel = document.getElementById("note_label");
        var noteInput = document.getElementById("note");
        var noteHint = document.getElementById("note_hint");

        secWork.classList.add("hidden");
        secSick.classList.add("hidden");
        secFinance.classList.add("hidden");

        noteInput.classList.remove("required-highlight");
        noteLabel.classList.remove("required-label");
        noteInput.required = false;
        noteInput.placeholder = "Opcion√°lis megjegyz√©s...";

        switch(status) {
            case "WORK":
                secWork.classList.remove("hidden");
                secFinance.classList.remove("hidden");
                break;
            case "WEATHER":
                noteInput.placeholder = "Milyen id≈ëj√°r√°s akad√°lyozta a munk√°t?";
                break;
            case "SICK":
                secSick.classList.remove("hidden");
                noteInput.placeholder = "V√°rhat√≥an mikor j√∂ssz dolgozni?";
                break;
            case "ABSENCE":
            case "OTHER":
                noteInput.classList.add("required-highlight");
                noteLabel.classList.add("required-label");
                noteInput.required = true;
                noteInput.placeholder = "K√©rlek indokold meg a t√°voll√©tet!";
                noteHint.innerText = "A hi√°nyz√°s ok√°nak megad√°sa k√∂telez≈ë!";
                break;
        }
    }

    // 3. Valid√°ci√≥
    function validateForm() {
        var status = document.getElementById("status_selector").value;
        var note = document.getElementById("note").value.trim();
        if ((status === "ABSENCE" || status === "OTHER") && note === "") {
            alert("‚ö†Ô∏è Enn√©l a st√°tuszn√°l k√∂telez≈ë kit√∂lteni a megjegyz√©st!");
            document.getElementById("note").focus();
            return false;
        }
        return true;
    }

    // 4. √ìra kalkul√°tor
    function calcHours() {
        var start = document.getElementById("start_time").value;
        var end = document.getElementById("end_time").value;
        if(start && end) {
            var s = new Date("1970-01-01 " + start);
            var e = new Date("1970-01-01 " + end);
            var diff = (e - s) / 1000 / 60 / 60;
            if (diff < 0) diff += 24;
            document.getElementById("total-display").innerText = "‚è±Ô∏è Sz√°m√≠tott id≈ë: " + diff.toFixed(1) + " √≥ra";
        }
    }
</script>
{% endblock %}