{% load humanize %}
<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <title>Építőipari ERP - Műszerfal</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { font-family: sans-serif; margin: 2em; background-color: #f4f4f4; }
        h1 { color: #333; }

        /* Felső sáv gombbal */
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .new-project-btn { background-color: #005a9c; color: white; padding: 12px 20px; text-decoration: none; border-radius: 5px; font-weight: bold; font-size: 1.1em; }

        /* === ÚJ KERESŐSÁV STÍLUS === */
        .search-bar-container {
            background-color: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .search-input {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 1em;
        }
        .search-btn {
            background-color: #333;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        .search-btn:hover { background-color: #555; }
        .clear-search {
            color: #d9534f;
            text-decoration: none;
            font-weight: bold;
            padding: 0 10px;
        }
        /* ========================== */

        /* MŰSZERFAL KÁRTYÁK */
        .dashboard-grid { display: flex; gap: 20px; margin-bottom: 30px; flex-wrap: wrap; }
        .card { background-color: #fff; border-radius: 8px; padding: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); flex: 1; min-width: 250px; }
        .card h3 { margin-top: 0; color: #555; font-size: 1em; text-transform: uppercase; }
        .card .value { font-size: 2em; font-weight: bold; color: #333; margin: 10px 0; }
        .card .sub { font-size: 0.9em; color: #777; }
        .balance-pos { color: #5cb85c !important; }
        .balance-neg { color: #d9534f !important; }

        /* GRAFIKONOK */
        .charts-container { display: flex; gap: 20px; margin-bottom: 40px; height: 350px; }
        .chart-box { background-color: #fff; border-radius: 8px; padding: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); flex: 1; position: relative; }

        /* PROJEKT LISTA */
        .project-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .project-card { background-color: #fff; border: 1px solid #ddd; border-radius: 5px; padding: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: transform 0.2s; }
        .project-card:hover { transform: translateY(-5px); box-shadow: 0 5px 15px rgba(0,0,0,0.15); }
        .project-card h2 { margin-top: 0; font-size: 1.4em; }
        .project-card h2 a { color: #005a9c; text-decoration: none; }
        .status { font-weight: bold; padding: 3px 8px; border-radius: 3px; background-color: #eee; color: #333; font-size: 0.85em; }
    </style>
</head>
<body>

    <div class="top-bar">
        <h1>Vállalati Áttekintés</h1>
        <a href="{% url 'project-create' %}" class="new-project-btn">+ Új Projekt Indítása</a>
    </div>

    <form method="GET" class="search-bar-container">
        <input type="text" name="q" class="search-input" placeholder="Keresés név, helyszín vagy ügyfél alapján..." value="{{ search_query }}">
        <button type="submit" class="search-btn">Keresés</button>
        {% if search_query %}
            <a href="{% url 'project-list' %}" class="clear-search" title="Keresés törlése">✖</a>
        {% endif %}
    </form>
    <div class="dashboard-grid">
        <div class="card">
            <h3>Összes Tervezett Költség</h3>
            <div class="value">{{ global_plan|floatformat:0|intcomma }} Ft</div>
            <div class="sub">
                {% if search_query %}Szűrt projektek{% else %}Minden aktív projekt{% endif %}
            </div>
        </div>
        <div class="card">
            <h3>Összes Valós Költés</h3>
            <div class="value">{{ global_spent|floatformat:0|intcomma }} Ft</div>
            <div class="sub">Rögzített számlák</div>
        </div>
        <div class="card">
            <h3>Vállalati Egyenleg</h3>
            <div class="value {% if global_balance >= 0 %}balance-pos{% else %}balance-neg{% endif %}">
                {{ global_balance|floatformat:0|intcomma }} Ft
            </div>
            <div class="sub">Terv - Tény</div>
        </div>
    </div>

    <div class="charts-container">
        <div class="chart-box">
            <canvas id="financeChart"></canvas>
        </div>
        <div class="chart-box">
            <canvas id="statusChart"></canvas>
        </div>
    </div>

    <h2>
        {% if search_query %}Keresési találatok{% else %}Aktív Projektek{% endif %}
    </h2>
    <hr>

    <div class="project-grid">
        {% for p in projects_key %}
            <div class="project-card">
                <h2><a href="{% url 'project-detail' p.id %}">{{ p.name }}</a></h2>
                <p class="meta">
                    <strong>Helyszín:</strong> {{ p.location }} <br>
                    <strong>Ügyfél:</strong> {{ p.client }} <br>
                    <span class="status">{{ p.get_status_display }}</span>
                </p>
            </div>
        {% empty %}
            <p>Nem található projekt a feltételek alapján.</p>
        {% endfor %}
    </div>

    <script>
        // Adatok átvétele a Django-ból
        const plan = {{ global_plan|stringformat:"f" }};
        const spent = {{ global_spent|stringformat:"f" }};

        // Státusz adatok
        const s_terv = {{ status_counts.TERVEZES }};
        const s_foly = {{ status_counts.FOLYAMATBAN }};
        const s_bef = {{ status_counts.BEFEJEZETT }};
        const s_lez = {{ status_counts.LEZART }};

        // 1. Pénzügyi Chart (Bar)
        const ctxFinance = document.getElementById('financeChart').getContext('2d');
        new Chart(ctxFinance, {
            type: 'bar',
            data: {
                labels: ['Tervezett Költség', 'Valós Költés'],
                datasets: [{
                    label: 'Összeg (Ft)',
                    data: [plan, spent],
                    backgroundColor: ['#005a9c', '#d9534f'],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    title: { display: true, text: 'Pénzügyi Helyzet' }
                }
            }
        });

        // 2. Státusz Chart (Doughnut)
        const ctxStatus = document.getElementById('statusChart').getContext('2d');
        new Chart(ctxStatus, {
            type: 'doughnut',
            data: {
                labels: ['Tervezés alatt', 'Folyamatban', 'Befejezett', 'Lezárt'],
                datasets: [{
                    data: [s_terv, s_foly, s_bef, s_lez],
                    backgroundColor: ['#f0ad4e', '#5cb85c', '#0275d8', '#333'],
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: { display: true, text: 'Projektek Státusza' }
                }
            }
        });
    </script>

</body>
</html>