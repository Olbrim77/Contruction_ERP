{% extends 'projects/base.html' %}
{% load humanize %}

{% block title %}Jelenléti Naptár{% endblock %}

{% block extra_css %}
<style>
  /* App-like fix elrendezés – egységes a HR oldalakkal */
  .fixed-layout-container { display:flex; flex-direction:column; height:85vh; background:#fff; border-radius:8px; box-shadow:0 4px 20px rgba(0,0,0,.15); overflow:hidden; border:1px solid #ddd; }
  .layout-header { flex:0 0 auto; background:#fff; border-bottom:1px solid #ddd; z-index:20; }
  .header-top { padding:16px 20px; display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap; }
  .page-title h1 { margin:0; color:#005a9c; font-size:20px; }
  .tabs { display:flex; gap:5px; padding:0 20px 10px; background:#f8f9fa; border-top:1px solid #eee; }
  .tab-btn { padding:10px 16px; cursor:pointer; border:none; background:transparent; color:#6c757d; font-weight:600; border-bottom:3px solid transparent; }
  .tab-btn.active { color:#005a9c; border-bottom-color:#005a9c; background:#fff; }
  .layout-content { flex:1 1 auto; overflow:auto; background:#f4f6f9; padding:20px; }
  .card { background:#fff; border:1px solid #e1e4e8; border-radius:8px; padding:16px; margin-bottom:16px; }

  /* Naptár-specifikus táblázat beállítások */
  .table-wrapper { overflow:auto; border:1px solid #ccc; background:#fff; }
  table { border-collapse: separate; border-spacing: 0; width: 100%; table-layout: fixed; font-size: 13px; }
  th, td { padding:0; text-align:center; border-right:1px solid #e0e0e0; border-bottom:1px solid #e0e0e0; height:26px; vertical-align:middle; box-sizing:border-box; }
  thead th { position:sticky; top:0; background:#f8f9fa; z-index:10; border-bottom:2px solid #bbb; font-weight:bold; color:#555; padding:4px 2px; height:auto; }
  /* Első (név) oszlop fix szélességű, a dátum oszlopok egyforma szélességgel kitöltik a maradék teret */
  .calendar-table { --namecol: 180px; }
  .calendar-table col.daycol { width: calc((100% - var(--namecol)) / var(--days)); }
  tbody th { position:sticky; left:0; background:#fff; z-index:5; text-align:left; width:var(--namecol); min-width:var(--namecol); border-right:2px solid #ccc; padding-left:10px; box-shadow:2px 0 5px rgba(0,0,0,0.05); }
  thead th:first-child { left:0; z-index:20; border-right:2px solid #ccc; }

  /* Státusz színek */
  .weekend { background-color:#f0f0f0; color:#bbb; }
  .holiday { background-color:#ffebee !important; color:#c62828 !important; font-weight:bold; border-left:2px solid #ef5350; border-right:2px solid #ef5350; }
  .holiday-header { background-color:#ffcdd2 !important; color:#b71c1c; border-bottom:2px solid #b71c1c; }
  .status-WORK { background-color:#e8f5e9; color:#2e7d32; font-weight:bold; }
  .status-SZ { background-color:#28a745; color:#fff; font-weight:bold; }
  .status-B { background-color:#dc3545; color:#fff; font-weight:bold; }
  .status-F { background-color:#6c757d; color:#fff; font-weight:bold; }
  .status-I { background-color:#000; color:#fff; font-weight:bold; }
  .status-K { background-color:#007bff; color:#fff; font-weight:bold; }
  .status-TP { background-color:#6f42c1; color:#fff; font-weight:bold; }
  .status-CS { background-color:#fd7e14; color:#fff; font-weight:bold; }
  .today-col { border:2px solid #005a9c !important; }
  .subrow { font-size:11px; color:#555; background:#fbfbfb; }
  .project-cell { font-style:italic; padding:2px 4px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:100%; }
  .editable-project { cursor: pointer; }
  .editable-project:hover { outline: 2px dashed #ffc107; outline-offset:-2px; background:#fff9e6; }
  .project-input { width: 100%; box-sizing: border-box; border:1px solid #ffc107; border-radius:4px; padding:2px 4px; font-size:12px; }
  /* Kontrasztosabb sorelválasztó az egyes dolgozói blokkok között */
  .subrow td { border-bottom: 2px solid #9aa0a6; }
  .mainrow th { border-bottom: 2px solid #9aa0a6 !important; }
  /* Inline szerkeszthető órák */
  .editable-hours { cursor: pointer; position: relative; }
  .editable-hours:hover { outline: 2px dashed #9ec5fe; outline-offset: -2px; background:#eef6ff; }
  /* Ünnepnév megjelenítés a fejlécben */
  .daynum { font-weight: 700; }
  .holiday-name { font-size: 10px; line-height: 1.1; color:#b71c1c; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; display:block; }
</style>
{% endblock %}

{% block content %}
<div class="fixed-layout-container">
  <div class="layout-header">
    <div class="header-top">
      <div class="page-title">
        <h1>Jelenléti Naptár</h1>
        <small>Hónap: {{ selected_date|date:"Y. F" }}</small>
      </div>
      <form method="get" style="display:flex; gap:10px; align-items:center;">
        <input type="month" name="month" value="{{ selected_date|date:'Y-m' }}">
        <button type="submit" class="btn btn-primary" style="background:#005a9c; color:#fff; border:none; padding:8px 12px; border-radius:4px;">Szűrés</button>
        <a class="btn btn-light" style="background:#fff; border:1px solid #ccc; color:#333; padding:8px 12px; border-radius:4px; text-decoration:none;" href="{% url 'hr-dashboard' %}?month={{ selected_date|date:'Y-m' }}">Vissza</a>
      </form>
    </div>
    <div class="tabs">
      <a class="tab-btn" href="{% url 'hr-dashboard' %}?month={{ selected_date|date:'Y-m' }}">Áttekintés</a>
      <button class="tab-btn active">Jelenlét</button>
      <a class="tab-btn" href="{% url 'hr-payroll' %}?month={{ selected_date|date:'Y-m' }}">Bérszámfejtés</a>
    </div>
  </div>

  <div class="layout-content">
    <div class="card">
      <div class="table-wrapper">
        <table class="calendar-table" style="--days: {{ header_days|length }};">
          <colgroup>
            <col style="width: var(--namecol);">
            {% for d in header_days %}
              <col class="daycol">
            {% endfor %}
          </colgroup>
          <thead>
            <tr>
              <th>Dolgozó</th>
              {% for d in header_days %}
                <th class="{% if d.is_holiday %}holiday-header{% elif d.is_weekend %}weekend{% endif %} {% if is_current_month and d.day == today_day %}today-col{% endif %}" title="{{ d.title }}">
                  <div class="daynum">{{ d.day }}</div>
                  {% if d.is_holiday and d.title %}
                    <small class="holiday-name">{{ d.title }}</small>
                  {% endif %}
                </th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for row in calendar_data %}
            <!-- Felső sor: órák / státusz -->
            <tr class="mainrow">
              <th rowspan="2">
                {{ row.employee.name }}<br>
                <small style="font-weight:normal; color:#888;">{{ row.employee.position }}</small>
              </th>
              {% for day in row.days %}
                {% with full_date=selected_date|date:'Y-m' %}
                <td class="editable-hours {% if day.is_holiday %}holiday{% elif day.is_weekend %}weekend{% endif %} status-{{ day.status }} {% if is_current_month and day.day == today_day %}today-col{% endif %}"
                    data-employee-id="{{ row.employee.id }}"
                    data-date="{{ full_date }}-{{ day.day|stringformat:'02d' }}"
                    title="Kattints a módosításhoz: {{ full_date }}-{{ day.day|stringformat:'02d' }}">
                  {% if day.attendance %}
                    {% if day.hours %}
                      <span class="hours-val">{{ day.hours|floatformat:1 }}</span>
                    {% else %}
                      <span class="hours-val"></span>
                    {% endif %}
                  {% else %}
                    {% if day.is_holiday %}
                      <span style="color:#b71c1c; font-size:0.8em;">Ü</span>
                    {% else %}
                      <span class="hours-val"></span>
                    {% endif %}
                  {% endif %}
                </td>
                {% endwith %}
              {% endfor %}
            </tr>
            <!-- Alsó sor: teljesítés helye (projekt) -->
            <tr class="subrow">
              {% for day in row.days %}
                {% with full_date=selected_date|date:'Y-m' %}
                <td class="editable-project {% if day.is_holiday %}holiday{% elif day.is_weekend %}weekend{% endif %} {% if is_current_month and day.day == today_day %}today-col{% endif %}"
                    data-employee-id="{{ row.employee.id }}"
                    data-date="{{ full_date }}-{{ day.day|stringformat:'02d' }}">
                  <div class="project-cell">
                    {% if day.attendance and day.project_name %}
                      <span class="project-val" title="{{ day.project_name }}">{{ day.project_name }}</span>
                    {% else %}
                      <span class="project-val">&nbsp;</span>
                    {% endif %}
                  </div>
                </td>
                {% endwith %}
              {% endfor %}
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <div class="card" style="font-size: 0.85em; color:#444;">
      <div style="display:flex; gap: 15px; flex-wrap: wrap; align-items: center;">
        <span><strong>Jelmagyarázat:</strong></span>
        <div style="display:flex; align-items:center; gap:5px;"><span style="width:15px; height:15px; background:#e8f5e9; border:1px solid #ccc; display:inline-block;"></span><span style="color:#2e7d32;">8 = Munka</span></div>
        <div style="display:flex; align-items:center; gap:5px;"><span style="width:15px; height:15px; background:#28a745; display:inline-block;"></span><span><strong>SZ</strong> = Fiz. Szabadság</span></div>
        <div style="display:flex; align-items:center; gap:5px;"><span style="width:15px; height:15px; background:#dc3545; display:inline-block;"></span><span><strong>B</strong> = Beteg</span></div>
        <div style="display:flex; align-items:center; gap:5px;"><span style="width:15px; height:15px; background:#6c757d; display:inline-block;"></span><span><strong>F</strong> = Fiz. Nélküli</span></div>
        <div style="display:flex; align-items:center; gap:5px;"><span style="width:15px; height:15px; background:#000000; display:inline-block;"></span><span><strong>I</strong> = Igazolatlan</span></div>
        <div style="display:flex; align-items:center; gap:5px;"><span style="width:15px; height:15px; background:#007bff; display:inline-block;"></span><span><strong>K</strong> = Külföld</span></div>
        <div style="display:flex; align-items:center; gap:5px;"><span style="width:15px; height:15px; background:#6f42c1; display:inline-block;"></span><span><strong>TP</strong> = Tanulmányi</span></div>
        <div style="display:flex; align-items:center; gap:5px;"><span style="width:15px; height:15px; background:#fd7e14; display:inline-block;"></span><span><strong>CS</strong> = Csúsztatás</span></div>
        <div style="display:flex; align-items:center; gap:5px; margin-left: 10px;"><span style="width:15px; height:15px; background:#ffebee; border:1px solid #ef5350; display:inline-block;"></span><span>Ünnepnap</span></div>
        <div style="display:flex; align-items:center; gap:5px;"><span style="width:15px; height:15px; background:#f0f0f0; border:1px solid #ccc; display:inline-block;"></span><span>Hétvége</span></div>
      </div>
    </div>
  </div>
</div>
<datalist id="active-projects-list">
  {% for p in active_projects %}
    <option value="{{ p.name }}"></option>
  {% endfor %}
  <!-- JSON adat a projektekhez biztonságosan -->
  {{ active_projects|json_script:"active-projects-json" }}
</datalist>

<script>
  // CSRF védelem fetch-hez
  function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';');
          for (let i = 0; i < cookies.length; i++) {
              const cookie = cookies[i].trim();
              if (cookie.substring(0, name.length + 1) === (name + '=')) {
                  cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                  break;
              }
          }
      }
      return cookieValue;
  }
  const csrftoken = getCookie('csrftoken');
  // Aktív projektek listája JS-ben (biztonságos JSON-ból)
  const ACTIVE_PROJECTS = JSON.parse(document.getElementById('active-projects-json').textContent || '[]');

  function isValidStep05(val) {
      // engedélyezett pl: 0, 0.5, 1, 1.5 ... 16
      const n = Number(val);
      if (isNaN(n)) return false;
      if (n < 0 || n > 16) return false;
      return Math.abs(n * 2 - Math.round(n * 2)) < 1e-9; // 0.5 lépés
  }

  document.addEventListener('click', function (e) {
      const td = e.target.closest('td.editable-hours');
      if (!td) return;

      const span = td.querySelector('.hours-val');
      const current = span ? (span.textContent || '').trim() : '';
      const employeeId = td.getAttribute('data-employee-id');
      const dateStr = td.getAttribute('data-date');

      const input = prompt('Óraszám megadása (0-16, 0.5 lépés):', current || '');
      if (input === null) return; // megszakítva

      if (input === '') {
          // üres érték -> 0-ként kezeljük
      }

      const val = input === '' ? '0' : input.replace(',', '.');
      if (!isValidStep05(val)) {
          alert('Érvénytelen óraszám. 0 és 16 között, 0.5 lépésben adható meg.');
          return;
      }

      td.style.opacity = '0.6';

      fetch('{% url "hr-calendar-update" %}', {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': csrftoken
          },
          body: JSON.stringify({
              employee_id: Number(employeeId),
              date: dateStr,
              field: 'hours',
              value: Number(val),
              reason: ''
          })
      }).then(r => r.json())
        .then(data => {
            if (data.ok) {
                if (span) span.textContent = parseFloat(data.hours).toFixed(1);
            } else {
                alert(data.error || 'Mentési hiba');
            }
        })
        .catch(() => alert('Hálózati hiba'))
        .finally(() => { td.style.opacity = '1'; });
  });

  // Projekt (alsó sor) inline szerkesztés
  document.addEventListener('click', function(e){
      const cell = e.target.closest('td.editable-project');
      if (!cell) return;

      // Ha már van input aktív, ne hozzunk létre újat ugyanabba a cellába
      if (cell.querySelector('input.project-input')) return;

      const span = cell.querySelector('.project-val');
      const currentName = span ? (span.textContent || '').trim() : '';

      const input = document.createElement('input');
      input.setAttribute('list', 'active-projects-list');
      input.className = 'project-input';
      input.value = currentName === '\u00a0' ? '' : currentName; // &nbsp; eset
      cell.querySelector('.project-cell').appendChild(input);
      input.focus();
      input.select();

      const employeeId = Number(cell.getAttribute('data-employee-id'));
      const dateStr = cell.getAttribute('data-date');

      function finish(save){
          input.removeEventListener('keydown', onKey);
          input.removeEventListener('blur', onBlur);

          if (!save){
              input.remove();
              return;
          }

          const typed = (input.value || '').trim();
          // Üres -> törlés
          let payloadValue = null;
          let newName = '';
          if (typed){
              const found = ACTIVE_PROJECTS.find(p => p.name === typed);
              if (!found){
                  alert('Ismeretlen projekt. Válassz a listából.');
                  input.focus();
                  return;
              }
              payloadValue = found.id;
              newName = found.name;
          }

          cell.style.opacity = '0.6';
          fetch('{% url "hr-calendar-update" %}', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
              body: JSON.stringify({
                  employee_id: employeeId,
                  date: dateStr,
                  field: 'project',
                  value: payloadValue,
                  reason: ''
              })
          }).then(r => r.json())
            .then(data => {
                if (data.ok){
                    const proj = data.project || {id:null, name:''};
                    span.textContent = proj.name || '\u00a0';
                    if (proj.name){ span.setAttribute('title', proj.name); } else { span.removeAttribute('title'); }
                } else {
                    alert(data.error || 'Mentési hiba');
                }
            })
            .catch(() => alert('Hálózati hiba'))
            .finally(() => { cell.style.opacity = '1'; input.remove(); });
      }

      function onKey(ev){
          if (ev.key === 'Enter') { finish(true); }
          else if (ev.key === 'Escape'){ finish(false); }
      }
      function onBlur(){ finish(true); }

      input.addEventListener('keydown', onKey);
      input.addEventListener('blur', onBlur);
  });
</script>
{% endblock %}