{% extends 'projects/base.html' %}
{% load humanize %}

{% block title %}M≈±szerfal - Kocsis √âp√≠t≈ë{% endblock %}

{% block breadcrumbs %}
    Kezd≈ëlap / <span>M≈±szerfal & Projektek</span>
{% endblock %}

{% block extra_css %}
<style>
    /* KERES≈ê */
    .search-bar-container { background-color: #fff; padding: 15px; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 30px; display: flex; gap: 10px; }
    .search-input { flex-grow: 1; padding: 10px; border: 1px solid #ccc; border-radius: 4px; }

    /* DASHBOARD K√ÅRTY√ÅK */
    .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .card { background-color: #fff; border-radius: 8px; padding: 20px; border: 1px solid var(--border); border-top: 4px solid #ccc; }
    .card.plan { border-top-color: #005a9c; } .card.spent { border-top-color: #d9534f; } .card.balance { border-top-color: #28a745; }
    .card h3 { margin: 0 0 10px 0; font-size: 12px; color: var(--secondary); text-transform: uppercase; letter-spacing: 1px; }
    .card .value { font-size: 24px; font-weight: bold; color: var(--text-dark); }
    .text-success { color: #28a745; } .text-danger { color: #d9534f; }

    /* GRAFIKONOK */
    .charts-container { display: flex; gap: 20px; margin-bottom: 40px; flex-wrap: wrap; }
    .chart-box { background-color: #fff; border-radius: 8px; padding: 20px; border: 1px solid var(--border); flex: 1; min-width: 300px; height: 300px; }

    /* PROJEKT K√ÅRTY√ÅK */
    .project-section { margin-bottom: 40px; }
    .section-title { font-size: 18px; font-weight: bold; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; color: #444; }
    .counter { background: #e9ecef; color: #555; font-size: 12px; padding: 2px 8px; border-radius: 10px; }

    .project-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
    .project-card {
        background: #fff; border: 1px solid var(--border); border-radius: 8px; padding: 20px;
        transition: transform 0.2s, box-shadow 0.2s; display: flex; flex-direction: column; justify-content: space-between;
    }
    .project-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.05); border-color: var(--primary); }
    .project-title { font-size: 18px; font-weight: 600; color: var(--primary); margin: 0 0 10px 0; }
    .project-meta { font-size: 13px; color: #666; line-height: 1.6; margin-bottom: 15px; }
    .project-footer { border-top: 1px solid #f0f0f0; padding-top: 15px; margin-top: auto; display: flex; justify-content: space-between; font-size: 12px; color: #999; }
</style>
{% endblock %}

{% block content %}
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="margin:0;">V√°llalati √Åttekint√©s</h2>
        <a href="{% url 'project-create' %}" class="btn btn-primary"><i class="fa-solid fa-plus"></i> √öj Projekt</a>
    </div>

    <form method="GET" class="search-bar-container">
        <input type="text" name="q" class="search-input" placeholder="Keres√©s n√©v, helysz√≠n vagy √ºgyf√©l alapj√°n..." value="{{ search_query }}">
        <button type="submit" class="btn btn-secondary">Keres√©s</button>
        {% if search_query %}<a href="{% url 'project-list' %}" style="color:#d9534f; font-weight:bold;">X</a>{% endif %}
    </form>

    <div class="dashboard-grid">
        <div class="card plan"><h3>Tervezett K√∂lts√©g</h3><div class="value">{{ global_plan|floatformat:0|intcomma }} Ft</div></div>
        <div class="card spent"><h3>Val√≥s K√∂lt√©s</h3><div class="value">{{ global_spent|floatformat:0|intcomma }} Ft</div></div>
        <div class="card balance"><h3>Egyenleg</h3><div class="value {% if global_balance >= 0 %}text-success{% else %}text-danger{% endif %}">{{ global_balance|floatformat:0|intcomma }} Ft</div></div>
    </div>

    <div class="charts-container">
        <div class="chart-box"><canvas id="financeChart"></canvas></div>
        <div class="chart-box"><canvas id="statusChart"></canvas></div>
    </div>

    {% for group in project_groups %}
        <div class="project-section">
            <div class="section-title">
                {{ group.label }} <span class="counter">{{ group.projects.count }}</span>
            </div>
            <div class="project-grid">
                {% for p in group.projects %}
                    <a href="{% url 'project-detail' p.id %}" class="project-card">
                        <div class="project-title">{{ p.name }}</div>
                        <div class="project-meta">
                            <div><i class="fa-solid fa-location-dot"></i> {{ p.location }}</div>
                            <div><i class="fa-solid fa-user"></i> {{ p.contact_name|default:p.client }}</div>
                            {% if p.budget %}<div style="margin-top:5px; font-weight:bold;">üí∞ {{ p.budget|floatformat:0|intcomma }} Ft</div>{% endif %}
                        </div>
                        <div class="project-footer">
                            <span>Kezd√©s: {{ p.start_date|date:"Y.m.d"|default:"-" }}</span>
                            <span>#{{ p.id }}</span>
                        </div>
                    </a>
                {% endfor %}
            </div>
        </div>
    {% empty %}
        <div style="text-align:center; padding:50px; color:#777;"><h3>Nincsenek projektek.</h3></div>
    {% endfor %}

    <script>
        new Chart(document.getElementById('financeChart'), { type: 'bar', data: { labels: ['Tervezett', 'T√©ny'], datasets: [{ label: 'Ft', data: [{{ global_plan|stringformat:"f" }}, {{ global_spent|stringformat:"f" }}], backgroundColor: ['#005a9c', '#d9534f'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { title: {display:true, text:'P√©nz√ºgyek'} } } });
        new Chart(document.getElementById('statusChart'), { type: 'doughnut', data: { labels: ['Tervez√©s', 'Folyamatban', 'K√©sz', 'Lez√°rt'], datasets: [{ data: [{{ status_counts.TERVEZES }}, {{ status_counts.FOLYAMATBAN }}, {{ status_counts.BEFEJEZETT }}, {{ status_counts.LEZART }}], backgroundColor: ['#ffc107', '#28a745', '#17a2b8', '#343a40'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { title: {display:true, text:'St√°tusz'}, legend:{position:'right'} } } });
    </script>
{% endblock %}