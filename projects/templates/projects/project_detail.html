{% load humanize %}

<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <title>{{ project.name }} - R√©szletek</title>

    <style>
        body { font-family: sans-serif; margin: 2em; background-color: #f4f4f4; }
        h1, h2 { color: #333; border-bottom: 2px solid #005a9c; padding-bottom: 5px; }
        .details {
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .meta { font-size: 1.1em; line-height: 1.6; }

        .back-link {
            display: inline-block;
            margin-top: 20px;
            text-decoration: none;
            color: #005a9c;
            font-weight: bold;
        }
        .deletion-warning {
            background-color: #fcf8e3;
            border: 1px solid #fae29f;
            color: #8a6d3b;
            padding: 15px;
            border-radius: 5px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 15px;
        }

        .button-container { margin-bottom: 15px; }
        .button {
            display: inline-block;
            color: white;
            padding: 8px 12px;
            text-decoration: none;
            border-radius: 5px;
            font-weight: bold;
            font-size: 0.9em;
            margin-left: 10px;
            cursor: pointer;
            border: none;
        }
        .btn-edit { background-color: #f0ad4e; }
        .btn-delete { background-color: #d9534f; }
        .btn-import { background-color: #5cb85c; margin-left: 0; }
        .btn-print { background-color: #31708f; margin-left: 0; }

        .excel-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            font-size: 0.9em;
            background-color: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .excel-table th, .excel-table td {
            border: 1px solid #ddd;
            padding: 8px 10px;
            text-align: left;
            /* T√∂rdel√©s enged√©lyez√©se a hossz√∫ szavakn√°l */
            word-break: break-word;
        }
        .excel-table thead th {
            background-color: #f2f2f2;
            font-weight: bold;
            color: #333;
        }
        .excel-table tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .excel-table td.numeric {
            text-align: right;
            font-family: monospace;
            /* Megakad√°lyozza, hogy a sz√°mok megt√∂rjenek */
            white-space: nowrap;
        }
        .excel-table td.editable a {
            display: block;
            text-decoration: none;
            color: #005a9c;
            font-weight: bold;
            white-space: nowrap;
        }
        .excel-table td.editable a:hover {
            background-color: #f0f8ff;
        }
        /* Szerkeszt√©s gomb cella */
        .excel-table td.actions {
            text-align: center;
            white-space: nowrap;
        }
        .excel-table td.actions a {
            text-decoration: none;
            padding: 4px;
        }

        .summary-box {
            background-color: #fff;
            border: 2px solid #005a9c;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .summary-box h2 {
            margin-top: 0;
            border-bottom: none;
            color: #005a9c;
        }
        .summary-box p {
            font-size: 1.1em;
            margin: 10px 0;
            overflow: hidden;
        }
        .summary-box p span {
            font-weight: bold;
            float: right;
            color: #333;
            font-family: monospace;
        }
        .summary-box hr {
            border: 0;
            border-top: 1px solid #ddd;
            margin: 15px 0;
        }
        .summary-box p.total {
            font-size: 1.3em;
            font-weight: bold;
        }
        .summary-box p.total span {
            color: #005a9c;
            font-size: 1.1em;
        }

        @media print {
            body { margin: 0; background-color: #fff; }
            .no-print, .back-link { display: none !important; }
            .details, .summary-box, .excel-table { box-shadow: none; border: 1px solid #ccc; }
            h1, h2 { border: none; }
            .excel-table { page-break-inside: auto; }
            .excel-table tr { page-break-inside: avoid; page-break-after: auto; }
            /* Nyomtat√°sban a szerkeszt≈ë linkeket elt√ºntetj√ºk */
            .excel-table td.editable a { color: black; text-decoration: none; font-weight: normal; }
            .excel-table td.actions { display: none; }
            .excel-table th.actions { display: none; }
        }
    </style>
</head>
<body>

    <h1>{{ project.name }}</h1>

    <div class="button-container no-print">
        {% if project.status == 'TORLES_KERELEM' %}
            <div class="deletion-warning">
                Ez a projekt t√∂rl√©sre lett jel√∂lve. Adminisztr√°tori j√≥v√°hagy√°sra v√°r.
            </div>
        {% else %}
            <button onclick="window.print()" class="button btn-print">
                üñ®Ô∏è Nyomtat√°s / PDF
            </button>
            <a href="{% url 'import-tasks' project.id %}" class="button btn-import">
                üì• T√©telsor Import√°l√°s (Excel)
            </a>
            <a href="{% url 'project-update' project.id %}" class="button btn-edit">
                ‚úé Projekt Szerkeszt√©se
            </a>
            <a href="{% url 'project-request-delete' project.id %}" class="button btn-delete">
                üóëÔ∏è T√∂rl√©s K√©relmez√©se
            </a>
        {% endif %}
    </div>

    <div class="details">
        <p class="meta">
            <strong>Helysz√≠n:</strong> {{ project.location }} <br>
            <strong>√úgyf√©l:</strong> {{ project.client|default:"Nincs megadva" }} <br>
            <strong>St√°tusz:</strong> {{ project.get_status_display }} <br>
            <strong>Tervezett id≈ëtartam:</strong>
                {% if project.start_date %}
                    {{ project.start_date|date:"Y-m-d" }} -
                    {{ calculated_end_date|date:"Y-m-d"|default:"N/A" }}
                    ({{ total_workdays }} munkanap)
                {% else %}
                    Nincs kezd√©si d√°tum megadva
                {% endif %}
            <br>
            <strong>Rezs√≠√≥ab√©r:</strong> {{ project.hourly_rate|floatformat:0|intcomma }} Ft/√≥ra <br>
            <strong>Tervezett munka√≥ra / nap:</strong> {{ project.hours_per_day|floatformat:2 }} √≥ra <br>
            <strong>Alkalmazott √ÅFA kulcs:</strong> {{ project.vat_rate }}%
        </p>
    </div>

    <div class="summary-box">
        <h2>P√©nz√ºgyi √ñsszegz√©s</h2>
        <p>
            Teljes Anyagk√∂lts√©g (Nett√≥):
            <span>{{ total_anyag|floatformat:0|intcomma }} HUF</span>
        </p>
        <p>
            Teljes Munkad√≠j (Nett√≥):
            <span>{{ total_dij|floatformat:0|intcomma }} HUF</span>
        </C>
        <p class="total">
            Projekt V√©g√∂sszeg (Nett√≥):
            <span>{{ total_project_netto|floatformat:0|intcomma }} HUF</span>
        </p>
        <hr>
        <p>
            √ÅFA ({{ vat_rate }}%):
            <span>{{ total_vat|floatformat:0|intcomma }} HUF</span>
        </p>
        <p class="total">
            Projekt V√©g√∂sszeg (Brutt√≥):
            <span>{{ total_project_brutto|floatformat:0|intcomma }} HUF</span>
        </p>
        <hr>
        <p>
            Tervezett id≈ër√°ford√≠t√°s:
            <span>{{ total_effort_hours|floatformat:2 }} √≥ra</span>
        </p>
    </div>

    <h2>K√∂lts√©gvet√©si T√©telsorok</h2>

    <div style="overflow-x: auto;">
        <table class="excel-table">
            <thead>
                <tr>
                    <th>Sorsz√°m</th> <th>T√©telsz√°m (B)</th>
                    <th>Le√≠r√°s (C)</th>
                    <th>Mennyis√©g (D)</th>
                    <th>Egys√©g (E)</th>
                    <th>Anyag √ñssz. (H)</th>
                    <th>D√≠j √ñssz. (I)</th>

                    <th>Normaid≈ë (N)</th>
                    <th>Megjegyz√©s (J)</th>
                    <th>Munkanem (M)</th>
                    <th>Alv√°llalkoz√≥ (O)</th>

                    <th class="actions no-print">M≈±veletek</th> </tr>
            </thead>
            <tbody>
                {% for tetel in tasks %}
                <tr>
                    <td>{{ tetel.sorszam }}</td> <td>{{ tetel.tetelszam }}</td>
                    <td>{{ tetel.leiras }}</td>

                    <td class="numeric editable">
                        <a href="{% url 'tetelsor-edit-quantity' tetel.id %}">
                            {{ tetel.mennyiseg }}
                        </a>
                    </td>

                    <td>{{ tetel.egyseg }}</td>
                    <td class="numeric">{{ tetel.anyag_osszesen|floatformat:0|intcomma }} HUF</td>
                    <td class="numeric">{{ tetel.dij_osszesen|floatformat:0|intcomma }} HUF</td>

                    <td class="numeric">{{ tetel.normaido|floatformat:2 }} √≥ra</td>
                    <td>{{ tetel.megjegyzes|default:"-" }}</td>
                    <td>{{ tetel.munkanem|default:"-" }}</td>
                    <td>{{ tetel.alvallalkozo|default:"-" }}</td>

                    <td class="actions no-print">
                        <a href="{% url 'tetelsor-edit' tetel.id %}" title="R√©szletes szerkeszt√©s">‚úèÔ∏è</a>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="12" style="text-align: center;">
                        Nincsenek t√©telsorok r√∂gz√≠tve ehhez a projekthez.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <hr>

    <a href="{% url 'project-list' %}" class="back-link no-print">&laquo; Vissza a projekt list√°ra</a>

</body>
</html>