{% extends 'projects/base.html' %}
{% load humanize %}

{% block title %}Napi Napl√≥ - {{ project.name }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    /* --- ALAPOK --- */
    body { background-color: #f0f2f5; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; padding: 0; color: #333; overflow-x: hidden; }
    .mobile-container { max-width: 600px; margin: 0 auto; background: #fff; min-height: 100vh; position: relative; display: flex; flex-direction: column; }

    /* --- FEJL√âC --- */
    .header-row { padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; background: #fff; position: sticky; top: 0; z-index: 20; }
    .header-row h2 { margin: 0; color: #005a9c; font-size: 1.2rem; }
    .back-link { text-decoration: none; color: #666; font-weight: bold; font-size: 0.9rem; }

    /* --- TAB BAR --- */
    .tab-nav { display: flex; background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.05); overflow-x: auto; white-space: nowrap; position: sticky; top: 55px; z-index: 15; scrollbar-width: none; }
    .tab-nav::-webkit-scrollbar { display: none; }
    .tab-btn { flex: 1; min-width: 75px; padding: 12px 5px; text-align: center; cursor: pointer; color: #666; border-bottom: 3px solid transparent; transition: all 0.2s; }
    .tab-btn i { font-size: 1.2rem; display: block; margin-bottom: 4px; }
    .tab-btn span { font-size: 0.65rem; font-weight: bold; text-transform: uppercase; }
    .tab-btn.active { color: #005a9c; border-bottom-color: #005a9c; background-color: #f8f9fa; }

    /* --- TARTALOM --- */
    .content-area { padding: 20px; flex-grow: 1; padding-bottom: 80px; }
    .tab-pane { display: none; animation: fadeIn 0.3s ease; }
    .tab-pane.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    /* --- ST√çLUSOK --- */
    .card-box { border: 1px solid #e1e4e8; border-radius: 12px; padding: 15px; background: #f8f9fa; margin-bottom: 15px; }
    label { display: block; font-weight: bold; margin-bottom: 8px; color: #444; font-size: 0.9rem; }
    input, textarea, select { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; box-sizing: border-box; background: #fff; }

    /* TERVT√ÅR ST√çLUSOK */
    .tree-container { background: #fff; border: 1px solid #e1e4e8; border-radius: 8px; padding: 10px; margin-bottom: 20px; }
    .tree-folder { display: flex; align-items: center; padding: 12px 10px; cursor: pointer; border-radius: 6px; font-weight: bold; color: #333; border-bottom: 1px solid #f5f5f5; }
    .folder-icon { color: #ffc107; margin-right: 10px; font-size: 1.3rem; }
    .folder-arrow { margin-left: auto; color: #999; transition: transform 0.2s; }
    .tree-folder.open .folder-arrow { transform: rotate(90deg); }
    .tree-children { display: none; padding-left: 15px; border-left: 2px solid #eee; margin-left: 18px; }
    .tree-children.show { display: block; }
    .tree-file { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #f9f9f9; }
    .file-icon { color: #6c757d; margin-right: 10px; font-size: 1.2rem; }
    .file-name { flex-grow: 1; font-size: 0.9rem; color: #555; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .btn-download { color: #005a9c; background: #e3f2fd; padding: 8px; border-radius: 6px; text-decoration: none; font-size: 1rem; }

    /* IG√âNYL√âS */
    .req-item { background: #fff; padding: 15px; border-radius: 8px; border: 1px solid #ddd; border-left: 5px solid #ccc; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
    .req-title { font-weight: bold; font-size: 1rem; display: block; }
    .req-meta { font-size: 0.8rem; color: #666; }
    .req-badge { font-size: 0.7rem; text-transform: uppercase; font-weight: bold; padding: 2px 6px; border-radius: 4px; background: #eee; color: #555; margin-right: 5px; }
    .type-ANYAG { border-left-color: #ffc107; } .type-ESZKOZ { border-left-color: #6c757d; }
    .type-SZAKIPAR { border-left-color: #17a2b8; } .type-SUPPORT { border-left-color: #dc3545; }

    /* EGY√âB */
    .weather-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 20px; }
    .weather-option { text-align: center; padding: 10px 5px; background: #fff; border: 1px solid #ccc; border-radius: 8px; cursor: pointer; }
    .weather-option.selected { background-color: #e3f2fd; border-color: #005a9c; color: #005a9c; }
    .btn-auto-weather { width: 100%; padding: 12px; background: #17a2b8; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-bottom: 20px; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .btn-save { width: 100%; padding: 15px; background: #005a9c; color: white; border: none; border-radius: 12px; font-size: 1.2rem; font-weight: bold; cursor: pointer; }
    .sticky-footer { position: fixed; bottom: 0; left: 0; right: 0; padding: 15px; background: #fff; border-top: 1px solid #eee; max-width: 600px; margin: 0 auto; z-index: 30; }
    .dynamic-row { display: flex; gap: 10px; margin-bottom: 10px; }
    .btn-remove { color: red; cursor: pointer; font-size: 1.2rem; padding: 5px; }
    .btn-add-field { width: 100%; padding: 10px; background: #eee; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; }
    .upload-box { border: 2px dashed #ccc; padding: 25px; text-align: center; background: #fff; border-radius: 8px; cursor: pointer; transition: 0.2s; }
</style>
{% endblock %}

{% block content %}

<div class="mobile-container">

    <div class="header-row">
        <a href="{% url 'mobile-project-detail' project.id %}" class="back-link">‚¨Ö M√©gse</a>
        <div>
            <h2 style="margin:0; font-size:1.2rem; text-align:center;">Napi Napl√≥</h2>
            <small style="color:#666; display:block; text-align:center;">{{ project.name|truncatechars:25 }}</small>
        </div>
        <div style="width: 40px;"></div>
    </div>

    <div class="tab-nav">
        <div class="tab-btn active" onclick="openTab('tab-1', this)"><i class="fa-regular fa-calendar-check"></i><span>Adatok</span></div>
        <div class="tab-btn" onclick="openTab('tab-2', this)"><i class="fa-solid fa-cloud-sun"></i><span>Id≈ëj√°r√°s</span></div>
        <div class="tab-btn" onclick="openTab('tab-3', this)"><i class="fa-solid fa-pen"></i><span>Le√≠r√°s</span></div>
        <div class="tab-btn" onclick="openTab('tab-4', this)"><i class="fa-solid fa-camera"></i><span>Fot√≥k</span></div>
        <div class="tab-btn" onclick="openTab('tab-5', this)"><i class="fa-solid fa-cart-flatbed"></i><span>Ig√©nyl√©s</span></div>
        <div class="tab-btn" onclick="openTab('tab-6', this)"><i class="fa-regular fa-folder-open"></i><span>Doksi</span></div>
    </div>

    <form method="POST" enctype="multipart/form-data" class="content-area">
        {% csrf_token %}

        <div id="tab-1" class="tab-pane active">
             <div class="card-box">
                <label>Munkav√©gz√©s ideje</label>
                <input type="date" name="date" value="{{ today|date:'Y-m-d' }}" style="margin-bottom:10px;">
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                    <div><label style="font-size:0.8rem;">Kezd√©s</label><input type="time" name="start_time" value="07:00"></div>
                    <div><label style="font-size:0.8rem;">Befejez√©s</label><input type="time" name="end_time" value="16:00"></div>
                </div>
             </div>

             <div class="card-box">
                <label>Alkalmazottak</label>
                <div id="employee_container" class="dynamic-list"></div>
                <button type="button" class="btn-add-field" onclick="addEmployee()">+ Dolgoz√≥</button>
             </div>

             <div class="card-box" style="border-left: 4px solid #ffc107;">
                <label>Alv√°llalkoz√≥k</label>
                <div id="subcontractor_container" class="dynamic-list"></div>
                <button type="button" class="btn-add-field" onclick="addSubcontractor()">+ Alv√°llalkoz√≥</button>
             </div>
        </div>

        <div id="tab-2" class="tab-pane">
            <div class="card-box">
                <label>√âgk√©p</label>
                <input type="hidden" name="weather" id="weather_status" value="NAPOS">
                <div class="weather-grid">
                    <div class="weather-option selected" onclick="selectWeather(this, 'NAPOS')"><i class="fa-solid fa-sun"></i>Napos</div>
                    <div class="weather-option" onclick="selectWeather(this, 'FELHOS')"><i class="fa-solid fa-cloud"></i>Felh≈ës</div>
                    <div class="weather-option" onclick="selectWeather(this, 'ESOS')"><i class="fa-solid fa-cloud-showers-heavy"></i>Es≈ës</div>
                </div>
            </div>
            <div class="card-box">
                <label>Le√≠r√°s</label>
                <textarea name="weather_note" rows="3" placeholder="H≈ëm√©rs√©klet, sz√©l, egy√©b..."></textarea>
            </div>
        </div>

        <div id="tab-3" class="tab-pane">
            <div class="card-box"><label>Elv√©gzett munka</label><textarea name="work_done" rows="6"></textarea></div>
            <div class="card-box" style="border-left: 5px solid #dc3545;"><label style="color:#dc3545;">Probl√©m√°k</label><textarea name="problems" rows="3"></textarea></div>
        </div>

        <div id="tab-4" class="tab-pane">
            <div class="card-box" style="text-align:center; border:2px dashed #ccc;">
                <input type="file" name="images" multiple accept="image/*" style="width:100%;">
                <p style="margin:5px 0; color:#666;">Kattints a f√°jlv√°laszt√°shoz vagy fot√≥z√°shoz</p>
            </div>
        </div>

        <div id="tab-5" class="tab-pane">
            <div class="card-box" style="border: 1px solid #005a9c;">
                <label><i class="fa-solid fa-plus-circle"></i> √öj Ig√©ny</label>
                <select id="req_type" style="font-weight:bold; color:#005a9c;">
                    <option value="ANYAG">Anyag</option>
                    <option value="ESZKOZ">Eszk√∂z</option>
                </select>
                <div style="display:grid; grid-template-columns: 2fr 1fr; gap:10px; margin:10px 0;">
                    <input type="text" id="req_name" placeholder="N√©v">
                    <input type="text" id="req_qty" placeholder="Menny.">
                </div>
                <input type="hidden" name="requests_json" id="requests_json">

                <button type="button" class="btn-add-field" style="background:#005a9c; color:white;" onclick="addRequest()">+ Hozz√°ad√°s a list√°hoz</button>
            </div>
            <div id="request_list_container"></div>
        </div>

        <div id="tab-6" class="tab-pane">

            <h3 style="color:#005a9c; margin:0 0 10px 0; font-size:1.1rem;">üìÇ K√∂zponti Tervek</h3>

            <div class="tree-container">
                {% for folder in root_folders %}
                    <div class="tree-item">
                        <div class="tree-folder" onclick="toggleFolder(this)">
                            <i class="fa-solid fa-folder folder-icon"></i> <span>{{ folder.name }}</span>
                            <i class="fa-solid fa-chevron-right folder-arrow"></i>
                        </div>
                        <div class="tree-children">
                            {% for file in folder.files.all %}
                                <div class="tree-file">
                                    <i class="fa-solid fa-file file-icon"></i>
                                    <span class="file-name">{{ file.name }}</span>
                                    <a href="{{ file.file.url }}" class="btn-download" download><i class="fa-solid fa-cloud-arrow-down"></i></a>
                                </div>
                            {% endfor %}

                            {% for sub in folder.subcategories.all %}
                                <div class="tree-item" style="margin-left:10px;">
                                    <div class="tree-folder" onclick="toggleFolder(this)">
                                        <i class="fa-solid fa-folder-open folder-icon" style="color:#ffca28;"></i>
                                        <span>{{ sub.name }}</span>
                                    </div>
                                    <div class="tree-children">
                                        {% for f in sub.files.all %}
                                            <div class="tree-file">
                                                <i class="fa-solid fa-file file-icon"></i>
                                                <span class="file-name">{{ f.name }}</span>
                                                <a href="{{ f.file.url }}" class="btn-download" download><i class="fa-solid fa-cloud-arrow-down"></i></a>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% empty %}
                    <p style="color:#999; text-align:center; padding:10px;">Nincsenek felt√∂lt√∂tt tervek.</p>
                {% endfor %}
            </div>

            <hr style="margin: 30px 0;">

            <h3 style="color:#444; margin-bottom:10px; font-size:1.1rem;">üì§ Dokumentum felt√∂lt√©se</h3>
            <div class="card-box">
                <input type="file" name="documents" multiple>
            </div>
        </div>

        <div class="sticky-footer">
            <button type="submit" class="btn-save">üíæ Napl√≥ R√∂gz√≠t√©se</button>
        </div>
    </form>

</div>

<script>
    // ADATOK DJANGO-B√ìL (A JS sz√°m√°ra)
    const employees = [
        {% for e in employees %}{id: "{{ e.id }}", name: "{{ e.name }}"},{% endfor %}
    ];
    const subcontractors = [
        {% for s in subcontractors %}{id: "{{ s.id }}", name: "{{ s.nev }}"},{% endfor %}
    ];

    // Dinamikus sorok kezel√©se
    function createSelectRow(listData, containerId, nameAttr) {
        const container = document.getElementById(containerId);
        const div = document.createElement('div');
        div.className = 'dynamic-row';
        let options = `<option value="">-- V√°lassz --</option>`;
        listData.forEach(item => options += `<option value="${item.id}">${item.name}</option>`);
        div.innerHTML = `<select name="${nameAttr}" style="width:100%; margin:0;">${options}</select><i class="fa-solid fa-trash btn-remove" onclick="this.parentElement.remove()"></i>`;
        container.appendChild(div);
    }

    function addEmployee() { createSelectRow(employees, 'employee_container', 'employees'); }
    function addSubcontractor() { createSelectRow(subcontractors, 'subcontractor_container', 'subcontractors'); }

    // Indul√°skor 1-1 sor
    document.addEventListener("DOMContentLoaded", function() {
        if(document.getElementById('employee_container').children.length === 0) addEmployee();
    });

    // Ig√©nyl√©s lista (Kliens oldali)
    let requests = [];

    function addRequest() {
        const typeSelect = document.getElementById('req_type');
        const typeCode = typeSelect.value;
        // A kiv√°lasztott opci√≥ sz√∂vege (ikon n√©lk√ºl)
        const typeText = typeSelect.options[typeSelect.selectedIndex].text.replace(/[^a-zA-Z√°√©√≠√≥√∂≈ë√∫√º≈±√Å√â√ç√ì√ñ≈ê√ö√ú≈∞\s]/g, '').trim();

        const text = document.getElementById('req_text').value;

        if(!text) { alert('K√©rlek √≠rd be, mit szeretn√©l!'); return; }

        const container = document.getElementById('request_list_container');
        const div = document.createElement('div');
        div.className = `req-item type-${typeCode}`;

        div.innerHTML = `
            <div>
                <span class="req-badge">${typeText}</span>
                <span class="req-title" style="font-weight:normal;">${text}</span>
            </div>
            <button type="button" class="btn-remove" onclick="removeRequest(this, '${text}')">
                <i class="fa-solid fa-trash"></i>
            </button>
        `;
        container.prepend(div);

        // Adat ment√©se JSON-ba (csak t√≠pus √©s sz√∂veg)
        requests.push({type: typeCode, text: text});
        updateJson();

        document.getElementById('req_text').value = '';
    }

    function removeRequest(btn, textToRemove) {
        // T√∂rl√©s a t√∂mbb≈ël
        requests = requests.filter(r => r.text !== textToRemove);
        updateJson();
        // T√∂rl√©s a DOM-b√≥l
        btn.parentElement.remove();
    }

    function updateJson() {
        document.getElementById('requests_json').value = JSON.stringify(requests);
    }

    // Tabok √©s Mapp√°k
    function openTab(tabId, btn) {
        document.querySelectorAll('.tab-pane').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        btn.classList.add('active');
    }
    function toggleFolder(el) {
        el.classList.toggle('open');
        el.nextElementSibling.classList.toggle('show');
    }
    function selectWeather(el, val) {
        document.querySelectorAll('.weather-option').forEach(e => e.classList.remove('selected'));
        el.classList.add('selected');
        document.getElementById('weather_status').value = val;
    }

    // Id≈ëj√°r√°s API
    function fetchWeatherData() {
        var btn = document.getElementById("weather-btn");
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>...';
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(pos) {
                var url = `https://api.open-meteo.com/v1/forecast?latitude=${pos.coords.latitude}&longitude=${pos.coords.longitude}&current_weather=true&daily=temperature_2m_max,temperature_2m_min&timezone=auto`;
                fetch(url).then(r => r.json()).then(d => {
                    document.getElementById("temp_night").value = d.daily.temperature_2m_min[0];
                    document.getElementById("temp_day").value = d.daily.temperature_2m_max[0];
                    btn.innerHTML = '‚úÖ K√©sz';
                    btn.style.background = '#28a745';
                });
            });
        }
    }
</script>

{% endblock %}